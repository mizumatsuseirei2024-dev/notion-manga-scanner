<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Notion Manga Scanner v5.6.4</title>
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const div = document.createElement("div");
            div.style.cssText = "position:fixed; top:0; left:0; width:100%; background:red; color:white; padding:10px; z-index:9999; font-family:monospace; font-size:12px; white-space:pre-wrap;";
            div.innerText = "Error: " + msg + "\nLine: " + line;
            document.body.appendChild(div);
            console.error(error);
        };
    </script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTML5-QRCode -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        :root {
            --bg-color: #292d3e;
            --text-main: #e0e6ed;
            --text-sub: #676e8a;
            --accent: #00d1b2;
            --shadow-light: #353a50;
            --shadow-dark: #1d202c;
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .neu-flat { background: var(--bg-color); box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light); border-radius: 1.5rem; border: 1px solid rgba(255,255,255,0.02); }
        .neu-btn { background: linear-gradient(145deg, #2c3042, #252838); box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light); border-radius: 9999px; color: var(--text-main); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s; }
        .neu-btn:active { box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light); transform: scale(0.98); }
        .neu-pressed { background: var(--bg-color); box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light); border-radius: 1rem; border: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #reader video { border-radius: 1rem; opacity: 0.8; filter: contrast(1.1) brightness(1.1); }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root">
        <div class="min-h-screen flex flex-col items-center justify-center bg-[#292d3e] space-y-6">
            <div class="neu-flat w-16 h-16 flex items-center justify-center animate-pulse">
                <span style="font-size: 24px;">ğŸ“š</span>
            </div>
            <div class="text-center">
                <p class="text-sm text-gray-400 mb-4">Loading App...</p>
                <button onclick="localStorage.clear(); window.location.reload();" class="text-xs text-red-400 border border-red-900 rounded px-3 py-2 hover:bg-red-900/20">
                    âš ï¸ èµ·å‹•ã—ãªã„å ´åˆã¯ã“ã“ã‚’æŠ¼ã—ã¦ãƒªã‚»ãƒƒãƒˆ
                </button>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons (Inline SVG) ---
        const Icon = ({ children, size = 24, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>
        );
        const ScanLine = (props) => <Icon {...props}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><line x1="7" x2="17" y1="12" y2="12"/></Icon>;
        const ListIcon = (props) => <Icon {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></Icon>;
        const SettingsIcon = (props) => <Icon {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>;
        const ImportIcon = (props) => <Icon {...props}><path d="M12 3v12"/><path d="m8 11 4 4 4-4"/><path d="M8 5H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-4"/></Icon>;
        const X = (props) => <Icon {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>;
        const Search = (props) => <Icon {...props}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></Icon>;
        const Edit2 = (props) => <Icon {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></Icon>;

        // --- Logic: Title Parsing & Fuzzy Matching ---
        const normalizeString = (str) => {
            if (!str) return "";
            return str.replace(/[ï¼-ï½]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                      .toLowerCase()
                      .replace(/[\s\tã€€ï¼š:ï¼â€•\-\(\)\[\]ï¼ˆï¼‰\.,!ï¼?ï¼Ÿ]/g, '');
        };

        const getLevenshteinDistance = (a, b) => {
            const an = a.length, bn = b.length;
            if (an === 0) return bn;
            if (bn === 0) return an;
            const matrix = Array.from(Array(bn + 1), () => Array(an + 1).fill(0));
            for (let i = 0; i <= an; i++) matrix[0][i] = i;
            for (let j = 0; j <= bn; j++) matrix[j][0] = j;
            for (let j = 1; j <= bn; j++) {
                for (let i = 1; i <= an; i++) {
                    const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                    matrix[j][i] = Math.min(matrix[j - 1][i] + 1, matrix[j][i - 1] + 1, matrix[j - 1][i - 1] + cost);
                }
            }
            return matrix[bn][an];
        };

        const parseBookTitle = (rawTitle, onixVolume = null) => {
            if (!rawTitle) return { full: "", series: "", volume: null };
            let title = rawTitle.replace(/[ï¼-ï½]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).trim().replace(/\s+/g, ' ');
            let seriesName = title, volume = null;
            if (onixVolume) {
                volume = parseInt(onixVolume, 10);
                seriesName = title.replace(new RegExp(`[\\s\\(ï¼ˆ\\[]*?(?:ç¬¬|v|vol\\.?)?\\s*${volume}(?:å·»)?[\\)ï¼‰\\]]*?(?:\\(.+?\\)|ï¼ˆ.+?ï¼‰|<.+?>)?$`, 'i'), '').trim().replace(/[\(\[\-]$/, '').trim();
                return { full: rawTitle, series: seriesName, volume };
            }
            const match = title.match(/^(.+?)[\s\.\-\(ï¼ˆ\[]*?(?:ç¬¬|v|vol\.?|volume|part)?\s*(\d+)(?:å·»)?[\s\)ï¼‰\]]*?(?:\(.+?\)|ï¼ˆ.+?ï¼‰|<.+?>)?$/i);
            if (match) {
                seriesName = match[1].trim().replace(/[\(\[\-]$/, '').trim();
                volume = parseInt(match[2], 10);
            }
            return { full: rawTitle, series: seriesName, volume };
        };

        // --- Logic: Author Name Cleaning ---
        const cleanAuthorName = (author) => {
            if (!author) return "";
            // ã‚«ãƒ³ãƒã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«ç½®æ›
            let cleaned = author.replace(/,/g, ' ');
            // é€£ç¶šã™ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ã‚’1ã¤ã«
            cleaned = cleaned.replace(/\s+/g, ' ');
            return cleaned.trim();
        };

        // --- Logic: Book Fetching (Shared) ---
        const fetchBookInfo = async (isbn) => {
            try {
                const cleanIsbn = isbn.replace(/[^0-9]/g, '');
                if (cleanIsbn.length !== 13) throw new Error("13æ¡ã®ISBNã‚’å…¥åŠ›");

                let bookData = { isbn: cleanIsbn, title: '', seriesName: '', volume: null, author: '', publisher: '', cover: '' };

                // 1. OpenBD
                try {
                    const res = await fetch(`https://api.openbd.jp/v1/get?isbn=${cleanIsbn}`);
                    const json = await res.json();
                    if (json && json[0]) {
                        const s = json[0].summary;
                        bookData.title = s.title;
                        bookData.author = cleanAuthorName(s.author);
                        bookData.publisher = s.publisher;
                        bookData.cover = s.cover;
                        try {
                            const o = json[0].onix;
                            const te = o?.DescriptiveDetail?.TitleDetail?.TitleElement;
                            const els = Array.isArray(te) ? te : [te];
                            const pel = els?.find(e => e?.PartNumber);
                            if (pel) bookData.volume = pel.PartNumber;
                        } catch(e){}
                    }
                } catch(e) { console.warn("OpenBD failed", e); }

                // 2. Google Books (ISBN)
                if (!bookData.title || !bookData.cover) {
                    try {
                        const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${cleanIsbn}`);
                        const json = await res.json();
                        if (json.items?.[0]?.volumeInfo) {
                            const info = json.items[0].volumeInfo;
                            if (!bookData.title) bookData.title = info.title;
                            if (!bookData.author && info.authors) bookData.author = cleanAuthorName(info.authors.join(' '));
                            if (!bookData.publisher && info.publisher) bookData.publisher = info.publisher;
                            if (!bookData.cover && info.imageLinks?.thumbnail) bookData.cover = info.imageLinks.thumbnail.replace(/^http:\/\//, 'https://');
                        }
                    } catch(e) { console.warn("Google Books ISBN failed", e); }
                }

                // 3. Google Books (Title Search)
                if (bookData.title && !bookData.cover) {
                    try {
                        const query = `${bookData.title} ${bookData.author}`.trim();
                        const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=1`);
                        const json = await res.json();
                        if (json.items?.[0]?.volumeInfo?.imageLinks?.thumbnail) bookData.cover = json.items[0].volumeInfo.imageLinks.thumbnail.replace(/^http:\/\//, 'https://');
                    } catch(e) { console.warn("Google Books Title Search failed", e); }
                }

                // 4. Open Library
                if (!bookData.cover) bookData.cover = `https://covers.openlibrary.org/b/isbn/${cleanIsbn}-L.jpg`;

                if (!bookData.title) throw new Error("ãƒ‡ãƒ¼ã‚¿ãªã—");

                const parsed = parseBookTitle(bookData.title, bookData.volume);
                return {
                    fullTitle: parsed.full,
                    seriesName: parsed.series,
                    volume: parsed.volume,
                    author: bookData.author,
                    publisher: bookData.publisher,
                    isbn: bookData.isbn,
                    cover: bookData.cover
                };
            } catch (e) {
                console.error(e);
                return null;
            }
        };

        // --- Logic: Notion Search (Shared) ---
        const searchNotionForSeries = async (seriesName, settings) => {
            if (!settings.notionToken || !settings.databaseId || !seriesName) return null;
            try {
                // æ¤œç´¢ç²¾åº¦ã®å‘ä¸Š: è¨˜å·ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«å¤‰æ›ã—ã€æœ€åˆã®æ„å‘³ã®ã‚ã‚‹å˜èª(2æ–‡å­—ä»¥ä¸Š)ã§æ¤œç´¢ã™ã‚‹
                const cleanName = seriesName.replace(/[ï¼š:ï¼â€•\-\(\)\[\]ï¼ˆï¼‰]/g, ' ').trim();
                const words = cleanName.split(/\s+/).filter(w => w.length > 0);
                let keyword = words[0];
                if (!keyword || keyword.length < 2) keyword = seriesName;

                let proxy = settings.proxyUrl || '';
                const target = `https://api.notion.com/v1/databases/${settings.databaseId}/query`;
                const url = proxy.includes('corsproxy.io') ? proxy + encodeURIComponent(target) : proxy + target;

                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${settings.notionToken}`, "Content-Type": "application/json", "Notion-Version": "2022-06-28" },
                    body: JSON.stringify({
                        filter: { property: "ä½œå“å", rich_text: { contains: keyword } },
                        page_size: 10,
                        sorts: [{ timestamp: "created_time", direction: "descending" }]
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.results && data.results.length > 0) {
                        const normTarget = normalizeString(seriesName);
                        let bestMatch = null;
                        let bestDistance = Infinity;

                        for (const page of data.results) {
                            const props = page.properties;
                            const getText = (p) => p?.rich_text?.[0]?.plain_text || p?.title?.[0]?.plain_text || "";
                            const existingSeriesName = getText(props["ä½œå“å"]);
                            const normExisting = normalizeString(existingSeriesName);
                            const dist = getLevenshteinDistance(normTarget, normExisting);
                            if (normTarget.includes(normExisting) || normExisting.includes(normTarget)) {
                                return { seriesName: existingSeriesName, author: getText(props["è‘—ä½œè€…"]), publisher: getText(props["å‡ºç‰ˆç¤¾"]) };
                            }
                            if (dist < bestDistance) {
                                bestDistance = dist;
                                bestMatch = { seriesName: existingSeriesName, author: getText(props["è‘—ä½œè€…"]), publisher: getText(props["å‡ºç‰ˆç¤¾"]) };
                            }
                        }
                        if (bestMatch && bestDistance <= Math.max(normTarget.length, 3) * 0.4) return bestMatch;
                    }
                }
            } catch (e) { console.error("Notion search failed", e); }
            return null;
        };

        // --- Components ---
        function App() {
            const [view, setView] = useState('scan');
            const [settings, setSettings] = useState(() => {
                const def = { notionToken: '', databaseId: '', proxyUrl: 'https://cors-anywhere.herokuapp.com/' };
                try {
                    const s = localStorage.getItem('manga_scanner_settings');
                    if (s) {
                        const p = JSON.parse(s);
                        return { ...def, ...p, proxyUrl: p.proxyUrl || def.proxyUrl };
                    }
                } catch (e) { console.error(e); }
                return def;
            });
            const [scannedBooks, setScannedBooks] = useState(() => {
                try {
                    const s = localStorage.getItem('manga_scanner_history');
                    return s ? JSON.parse(s) : [];
                } catch(e) { return []; }
            });

            useEffect(() => { localStorage.setItem('manga_scanner_settings', JSON.stringify(settings)); }, [settings]);
            useEffect(() => { localStorage.setItem('manga_scanner_history', JSON.stringify(scannedBooks)); }, [scannedBooks]);

            const addBook = (b) => {
                if (scannedBooks.some(x => x.isbn === b.isbn)) return alert('ãƒªã‚¹ãƒˆã«å­˜åœ¨ã—ã¾ã™');
                setScannedBooks([b, ...scannedBooks]);
                if (navigator.vibrate) navigator.vibrate(50);
                setView('history');
            };

            const addBooksBulk = (newBooks) => {
                const uniqueNewBooks = newBooks.filter(b => !scannedBooks.some(exist => exist.isbn === b.isbn));
                if (uniqueNewBooks.length > 0) {
                    setScannedBooks(prev => [...uniqueNewBooks, ...prev]);
                    if (navigator.vibrate) navigator.vibrate(200);
                }
                setView('history');
            };

            const updateBook = (ub) => setScannedBooks(scannedBooks.map(b => b.isbn === ub.isbn ? ub : b));

            return (
                <div className="relative w-full h-screen overflow-hidden flex flex-col animate-fade-in">
                    <div className="flex items-center justify-between px-6 pt-6 pb-2 z-10">
                        <div className="flex items-center gap-3">
                            <div className="neu-flat w-10 h-10 flex items-center justify-center text-xl">ğŸ“š</div>
                            <h1 className="text-xl font-bold tracking-wider text-[var(--text-main)]">SCANNER</h1>
                        </div>
                        <div className="text-[10px] text-[var(--text-sub)] font-mono tracking-widest">V5.6.4</div>
                    </div>
                    <div className="flex-grow overflow-y-auto hide-scrollbar px-4 pb-32">
                        {/* settings prop passed to all views */}
                        {view === 'scan' && <ScannerView onDetected={addBook} settings={settings} />}
                        {view === 'bulk' && <BulkImportView onBulkDetected={addBooksBulk} settings={settings} />}
                        {view === 'history' && <HistoryView books={scannedBooks} settings={settings} setBooks={setScannedBooks} onUpdate={updateBook} />}
                        {view === 'settings' && <SettingsView settings={settings} setSettings={setSettings} />}
                    </div>
                    <RadialMenu currentView={view} setView={setView} badgeCount={scannedBooks.length} />
                </div>
            );
        }

        function RadialMenu({ currentView, setView, badgeCount }) {
            const [isOpen, setIsOpen] = useState(false);
            const items = [
                { id: 'scan', icon: ScanLine, color: '#00d1b2' },
                { id: 'bulk', icon: ImportIcon, color: '#FF9F1C' },
                { id: 'history', icon: ListIcon, color: '#ff0080' },
                { id: 'settings', icon: SettingsIcon, color: '#7928ca' },
            ];
            return (
                <div className="fixed bottom-8 right-8 z-50 flex items-center justify-center">
                    <div className={`absolute transition-all duration-300 ${isOpen?'scale-100 opacity-100':'scale-50 opacity-0 pointer-events-none'}`}>
                        {items.map((it, i) => {
                            const total = items.length - 1;
                            const range = 90;
                            const startAngle = 180;
                            const ang = startAngle + (i * range / total);
                            const rad = 90;
                            const x = Math.cos(ang*Math.PI/180)*rad, y = Math.sin(ang*Math.PI/180)*rad;
                            const active = currentView === it.id;
                            return (
                                <button key={it.id} onClick={()=>{setView(it.id);setIsOpen(false)}} className={`absolute w-12 h-12 rounded-full flex items-center justify-center neu-btn text-[var(--text-main)] transition-all ${active?'text-[var(--accent)]':''}`} style={{transform:`translate(${x}px,${y}px)`, boxShadow: active ? `0 0 15px ${it.color}40, 5px 5px 10px #1d202c, -5px -5px 10px #353a50` : undefined }}>
                                    <it.icon size={20}/>
                                    {it.id==='history'&&badgeCount>0&&<span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-[9px] flex items-center justify-center text-white font-bold">{badgeCount}</span>}
                                </button>
                            );
                        })}
                    </div>
                    <button onClick={()=>setIsOpen(!isOpen)} className={`w-16 h-16 rounded-full neu-btn z-50 transition-transform duration-300 ${isOpen?'rotate-45':'rotate-0'}`} style={{color:isOpen?'#ff4d4d':'var(--accent)'}}>
                        <div className="text-2xl font-light">+</div>
                    </button>
                </div>
            );
        }

        // Updated ScannerView to use shared logic from global scope
        function ScannerView({ onDetected, settings }) {
            const [scanning, setScanning] = useState(false);
            const [manualIsbn, setManualIsbn] = useState('');
            const [loading, setLoading] = useState(false);
            const scannerRef = useRef(null);

            useEffect(() => {
                if (!scanning) return;
                const s = new Html5Qrcode("reader");
                scannerRef.current = s;
                s.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 }, aspect: 1.0, formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13 ] }, 
                    (d) => { if (d.startsWith('978')) { stop(); processIsbn(d); } }, 
                    () => {}
                ).catch(e => { console.error(e); setScanning(false); alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + e); });
                return () => stop();
            }, [scanning]);

            const stop = () => { if(scannerRef.current?.isScanning) scannerRef.current.stop().then(()=>scannerRef.current.clear()).catch(console.error); setScanning(false); };

            const processIsbn = async (isbn) => {
                setLoading(true);
                try {
                    const book = await fetchBookInfo(isbn);
                    if (!book) throw new Error("ãƒ‡ãƒ¼ã‚¿ãªã—");

                    // é¡ä¼¼ãƒ‡ãƒ¼ã‚¿çµ±åˆãƒ­ã‚¸ãƒƒã‚¯
                    if (book.seriesName) {
                        const existing = await searchNotionForSeries(book.seriesName, settings);
                        if (existing) {
                            if (confirm(`é¡ä¼¼ã‚·ãƒªãƒ¼ã‚ºã€${existing.seriesName}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚\næƒ…å ±ã‚’çµ±ä¸€ã—ã¾ã™ã‹ï¼Ÿ`)) {
                                book.seriesName = existing.seriesName;
                                if (existing.author) book.author = existing.author;
                                if (existing.publisher) book.publisher = existing.publisher;
                            }
                        }
                    }
                    onDetected(book);
                    setManualIsbn('');
                } catch(e) { alert(e.message); } finally { setLoading(false); }
            };

            return (
                <div className="flex flex-col items-center justify-center h-full space-y-8 animate-fade-in pt-8">
                    <div className="relative w-full max-w-xs aspect-square neu-flat flex flex-col items-center justify-center p-4 overflow-hidden group">
                        <div id="reader" className={`w-full h-full rounded-2xl overflow-hidden bg-black/40 ${scanning ? 'opacity-100' : 'opacity-50'}`}></div>
                        {!scanning && <button onClick={()=>setScanning(true)} className="absolute inset-0 flex items-center justify-center"><div className="neu-btn w-20 h-20 rounded-full text-2xl text-[var(--accent)]"><ScanLine size={32}/></div></button>}
                        {scanning && <div className="absolute inset-0 pointer-events-none border-2 border-[var(--accent)]/50 rounded-2xl animate-pulse"></div>}
                    </div>
                    {scanning && <button onClick={stop} className="neu-btn px-6 py-2 text-sm text-red-400 font-bold">STOP</button>}
                    <div className="w-full max-w-xs"><div className="neu-pressed flex items-center p-2 rounded-full"><input type="tel" placeholder="ISBN (978...)" value={manualIsbn} onChange={e=>setManualIsbn(e.target.value)} className="bg-transparent border-none outline-none text-[var(--text-main)] px-4 py-2 flex-grow font-mono text-lg" maxLength="13"/><button onClick={()=>{processIsbn(manualIsbn)}} disabled={loading||manualIsbn.length<10} className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${manualIsbn.length>=10?'bg-[var(--accent)] text-[#292d3e]':'text-gray-500'}`}><Search size={18}/></button></div></div>
                    {loading && <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center"><div className="neu-flat p-8 flex flex-col items-center animate-pop"><div className="w-10 h-10 border-4 border-[var(--accent)] border-t-transparent rounded-full animate-spin mb-4"></div><span className="font-bold tracking-widest text-sm">SEARCHING...</span></div></div>}
                </div>
            );
        }

        // Updated BulkImportView with Fuzzy Matching
        function BulkImportView({ onBulkDetected, settings }) {
            const [text, setText] = useState('');
            const [processing, setProcessing] = useState(false);
            const [progress, setProgress] = useState({ current: 0, total: 0 });
            const [logs, setLogs] = useState([]);

            const handleBulk = async () => {
                const isbns = text.match(/978[0-9-]{10,14}/g);
                if (!isbns || isbns.length === 0) return alert("ISBNãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (978ã‹ã‚‰å§‹ã¾ã‚‹æ•°å­—)");
                
                const uniqueIsbns = [...new Set(isbns.map(i => i.replace(/[^0-9]/g, '')))];
                
                setProcessing(true);
                setProgress({ current: 0, total: uniqueIsbns.length });
                setLogs([]);

                const acquiredBooks = [];
                const confirmedSeries = new Set(); // çµ±ä¸€ã‚’è¨±å¯ã—ãŸã‚·ãƒªãƒ¼ã‚ºå
                const deniedSeries = new Set();    // çµ±ä¸€ã‚’æ‹’å¦ã—ãŸã‚·ãƒªãƒ¼ã‚ºå

                for (let i = 0; i < uniqueIsbns.length; i++) {
                    setProgress(prev => ({ ...prev, current: i + 1 }));
                    const isbn = uniqueIsbns[i];
                    
                    try {
                        const book = await fetchBookInfo(isbn);
                        if (book) {
                            // ã‚†ã‚‰ãæ¤œçŸ¥ & çµ±åˆ (ä¸€æ‹¬ãƒ¢ãƒ¼ãƒ‰)
                            if (book.seriesName) {
                                const existing = await searchNotionForSeries(book.seriesName, settings);
                                if (existing) {
                                    const targetSeries = existing.seriesName;
                                    
                                    if (confirmedSeries.has(targetSeries)) {
                                        // æ—¢ã«è¨±å¯æ¸ˆã¿ -> è‡ªå‹•çµ±åˆ
                                        book.seriesName = existing.seriesName;
                                        if (existing.author) book.author = existing.author;
                                        if (existing.publisher) book.publisher = existing.publisher;
                                    } else if (!deniedSeries.has(targetSeries)) {
                                        // æœªç¢ºèª -> ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
                                        // æ³¨æ„: ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ä¸­ã¯å‡¦ç†ãŒæ­¢ã¾ã‚‹
                                        if (confirm(`ã€ä¸€æ‹¬ç™»éŒ²ç¢ºèªã€‘\né¡ä¼¼ã‚·ãƒªãƒ¼ã‚ºã€${targetSeries}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚\n(ã‚¹ã‚­ãƒ£ãƒ³çµæœ: ${book.seriesName})\n\næƒ…å ±ã‚’çµ±ä¸€ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ã€ŒOKã€ã‚’æŠ¼ã™ã¨ã€ã“ã®ã‚·ãƒªãƒ¼ã‚ºã®ä»–ã®å·»ã‚‚è‡ªå‹•ã§çµ±ä¸€ã•ã‚Œã¾ã™ã€‚`)) {
                                            confirmedSeries.add(targetSeries);
                                            book.seriesName = existing.seriesName;
                                            if (existing.author) book.author = existing.author;
                                            if (existing.publisher) book.publisher = existing.publisher;
                                        } else {
                                            deniedSeries.add(targetSeries);
                                        }
                                    }
                                }
                            }

                            acquiredBooks.push(book);
                            setLogs(prev => [`âœ… ${book.fullTitle}`, ...prev]);
                        } else {
                            setLogs(prev => [`âŒ ${isbn} (ãƒ‡ãƒ¼ã‚¿ãªã—)`, ...prev]);
                        }
                    } catch (e) {
                        setLogs(prev => [`âŒ ${isbn} (ã‚¨ãƒ©ãƒ¼)`, ...prev]);
                    }
                    
                    // APIãƒ¬ãƒ¼ãƒˆåˆ¶é™è€ƒæ…®
                    await new Promise(r => setTimeout(r, 1000));
                }
                
                setProcessing(false);
                
                if (acquiredBooks.length > 0) {
                    onBulkDetected(acquiredBooks);
                    alert(`${acquiredBooks.length}å†Šã‚’å–å¾—ã—ã¾ã—ãŸã€‚ãƒªã‚¹ãƒˆç”»é¢ã¸ç§»å‹•ã—ã¾ã™ã€‚`);
                } else {
                    alert("æ›¸ç±æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
                }
            };

            return (
                <div className="pt-4 space-y-6 animate-fade-in h-full flex flex-col">
                    <div className="neu-flat p-5 flex-grow flex flex-col">
                        <h3 className="font-bold text-[var(--accent)] mb-2 flex items-center gap-2"><ImportIcon size={18}/> ä¸€æ‹¬ç™»éŒ² (BULK)</h3>
                        <p className="text-xs text-[var(--text-sub)] mb-4">ISBNã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼ˆæ”¹è¡Œãƒ»ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚ŠOKï¼‰</p>
                        
                        <div className="neu-pressed p-2 flex-grow mb-4 rounded-xl">
                            <textarea 
                                value={text}
                                onChange={e => setText(e.target.value)}
                                placeholder="9784..."
                                className="w-full h-full bg-transparent border-none outline-none text-[var(--text-main)] text-sm resize-none font-mono"
                            ></textarea>
                        </div>

                        <button 
                            onClick={handleBulk} 
                            disabled={processing || !text}
                            className={`w-full py-3 rounded-xl font-bold text-sm shadow-lg transition-all ${processing ? 'bg-gray-600 text-gray-400' : 'bg-[var(--accent)] text-[#292d3e] hover:brightness-110'}`}
                        >
                            {processing ? `å–å¾—ä¸­ (${progress.current}/${progress.total})...` : 'ä¸€æ‹¬å–å¾—é–‹å§‹'}
                        </button>
                    </div>

                    {logs.length > 0 && (
                        <div className="neu-flat p-4 max-h-40 overflow-y-auto">
                            <h4 className="text-xs font-bold text-[var(--text-sub)] mb-2">ãƒ­ã‚°</h4>
                            <ul className="space-y-1">
                                {logs.map((log, i) => (
                                    <li key={i} className="text-xs truncate">{log}</li>
                                ))}
                            </ul>
                        </div>
                    )}
                </div>
            );
        }

        function HistoryView({ books, settings, setBooks, onUpdate }) {
            const [status, setStatus] = useState({});
            const [editing, setEditing] = useState(null);

            const send = async (book, silent = false) => {
                if(!settings.notionToken) {
                    if (!silent) alert("è¨­å®šãŒå¿…è¦ã§ã™");
                    return false;
                }
                setStatus(p=>({...p, [book.isbn]:'loading'}));

                try {
                    // --- é‡è¤‡ãƒã‚§ãƒƒã‚¯ (å¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œ) ---
                    try {
                        let proxy = settings.proxyUrl || '';
                        const getUrl = (target) => proxy.includes('corsproxy.io') ? proxy + encodeURIComponent(target) : proxy + target;
                        const queryUrl = getUrl(`https://api.notion.com/v1/databases/${settings.databaseId}/query`);
                        const queryRes = await fetch(queryUrl, {
                            method: "POST",
                            headers: { "Authorization": `Bearer ${settings.notionToken}`, "Content-Type": "application/json", "Notion-Version": "2022-06-28" },
                            body: JSON.stringify({ filter: { property: "ISBN", rich_text: { equals: book.isbn } } })
                        });
                        if (queryRes.ok) {
                            const queryData = await queryRes.json();
                            if (queryData.results?.length > 0) {
                                if (!silent) alert(`ã€Œ${book.fullTitle}ã€ã¯æ—¢ã«ç™»éŒ²æ¸ˆã¿ã§ã™ã€‚`);
                                setBooks(prev => prev.filter(b => b.isbn !== book.isbn));
                                setStatus(p => { const n = { ...p }; delete n[book.isbn]; return n; });
                                return true;
                            }
                        }
                    } catch(e) { console.warn("DupCheck Skipped:", e); }

                    // --- æœ¬é€ä¿¡ ---
                    let c = book.cover?.trim()||"";
                    if(c) { c=c.replace(/^http:\/\//i,'https://'); if(c.includes('books.google')||c.includes('googleapis')) c=c.replace('&edge=curl',''); }
                    const safe = t => t && String(t).trim().length>0 ? String(t) : "-";
                    
                    const props = {
                            "åå‰": { title: [{ text: { content: safe(book.fullTitle) } }] },
                            "ä½œå“å": { rich_text: [{ text: { content: safe(book.seriesName) } }] },
                            ...(book.volume ? { "å·»æ•°": { number: parseInt(book.volume) } } : {}),
                            "è‘—ä½œè€…": { rich_text: [{ text: { content: safe(book.author) } }] },
                            "å‡ºç‰ˆç¤¾": { rich_text: [{ text: { content: safe(book.publisher) } }] },
                            "ISBN": { rich_text: [{ text: { content: safe(book.isbn) } }] },
                    };
                    if (c) {
                        if (c.length <= 2000) props["æ›¸å½±URL"] = { url: c };
                        // Check URL length for Files property
                        if (c.length <= 2000) {
                            props["æ›¸å½±"] = { files: [{ name: safe(book.fullTitle), type: "external", external: { url: c } }] };
                        }
                    }

                    const body = { parent: { database_id: settings.databaseId }, cover: (c && c.length <= 2000) ? { type: "external", external: { url: c } } : null, properties: props };
                    const p = settings.proxyUrl;
                    const u = p.includes('corsproxy.io') ? p + encodeURIComponent('https://api.notion.com/v1/pages') : p + 'https://api.notion.com/v1/pages';
                    const r = await fetch(u, { method: "POST", headers: { "Authorization": `Bearer ${settings.notionToken}`, "Content-Type": "application/json", "Notion-Version": "2022-06-28" }, body: JSON.stringify(body) });
                    
                    if(r.ok) { 
                        setBooks(prev=>prev.filter(b=>b.isbn!==book.isbn)); 
                        setStatus(p=>{const n={...p}; delete n[book.isbn]; return n;}); 
                        return true;
                    } else {
                        // ä¿®æ­£ç®‡æ‰€: ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å–å¾—ã—ã¦ã‹ã‚‰JSONãƒ‘ãƒ¼ã‚¹
                        const errText = await r.text();
                        let msg = errText;
                        try {
                            const errJson = JSON.parse(errText);
                            if(errJson.message) msg = errJson.message;
                        } catch(e){}
                        throw new Error(`[${r.status}] ${msg}`);
                    }
                } catch(e) { 
                    console.error(e); 
                    setStatus(p=>({...p, [book.isbn]: e.message})); // è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
                    return false;
                }
            };

            const sendAll = async () => {
                if(!books.length || !confirm("ä¸€æ‹¬é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ")) return;
                const targets = [...books];
                for(const b of targets) { await new Promise(r=>setTimeout(r,1000)); await send(b, true); }
                alert("å®Œäº†");
            };

            if(!books.length) return <div className="h-full flex flex-col items-center justify-center text-[var(--text-sub)] opacity-50"><div className="text-6xl mb-4">ğŸ“­</div><p>NO BOOKS</p></div>;

            return (
                <div className="space-y-6 pt-4 animate-slide-up">
                    <div className="flex justify-between items-center px-2">
                        <span className="text-sm font-bold text-[var(--text-sub)]">{books.length} BOOKS</span>
                        <button onClick={sendAll} className="neu-btn px-4 py-2 text-xs font-bold text-[var(--accent)] hover:text-white">ALL SEND</button>
                    </div>
                    <div className="grid gap-4">
                        {books.map(b => (
                            <div key={b.isbn} className="neu-flat p-4 flex gap-4 relative overflow-hidden">
                                <div className="w-20 h-28 flex-shrink-0 rounded-lg overflow-hidden shadow-lg bg-[#202330] relative">
                                    {b.cover ? <img src={b.cover} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-xs text-gray-600 font-bold">NO IMG</div>}
                                </div>
                                <div className="flex-grow min-w-0 flex flex-col justify-between">
                                    <div>
                                        <div className="flex justify-between items-start">
                                            <h3 className="font-bold text-sm leading-tight line-clamp-2">{b.fullTitle}</h3>
                                            <button onClick={()=>{if(confirm('å‰Šé™¤?')) setBooks(books.filter(x=>x.isbn!==b.isbn))}} className="text-[var(--text-sub)] hover:text-red-400"><X size={16}/></button>
                                        </div>
                                        <div className="flex flex-wrap gap-2 mt-2">
                                            <span className="text-[10px] bg-[#202330] px-2 py-1 rounded text-[var(--accent)] border border-[var(--accent)]/20">{b.seriesName}</span>
                                            {b.volume && <span className="text-[10px] bg-[#202330] px-2 py-1 rounded text-white border border-white/10">{b.volume}</span>}
                                        </div>
                                        <p className="text-xs text-[var(--text-sub)] mt-1 truncate">{b.author}</p>
                                    </div>
                                    <div className="mt-2 flex flex-col items-end gap-1">
                                        <div className="flex gap-3">
                                            <button onClick={()=>setEditing(b)} className="p-2 rounded-full neu-btn text-[var(--text-sub)] hover:text-white"><Edit2 size={14}/></button>
                                            <button onClick={()=>send(b)} disabled={status[b.isbn]==='loading'} className={`px-4 py-1.5 rounded-full neu-btn text-xs font-bold ${status[b.isbn]?'text-red-400':'text-[var(--accent)]'}`}>{status[b.isbn]==='loading'?'...':'SEND'}</button>
                                        </div>
                                        {status[b.isbn] && status[b.isbn] !== 'loading' && (
                                            <p className="text-[10px] text-red-400 max-w-full break-all bg-[#202330] p-1 rounded border border-red-900/50">
                                                {status[b.isbn].includes('Failed to fetch') ? 'é€šä¿¡ã‚¨ãƒ©ãƒ¼: Proxyã‚’ç¢ºèª' : status[b.isbn]}
                                            </p>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    {editing && <EditDrawer book={editing} onClose={()=>setEditing(null)} onSave={onUpdate}/>}
                </div>
            );
        }

        function EditDrawer({ book, onClose, onSave }) {
            const [data, setData] = useState({ ...book });
            const handleChange = e => setData({ ...data, [e.target.name]: e.target.name==='volume'&&e.target.value?parseInt(e.target.value):e.target.value });
            return (
                <div className="fixed inset-0 z-50 flex items-end justify-center pointer-events-none">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto" onClick={onClose}></div>
                    <div className="neu-flat w-full max-w-md bg-[var(--bg-color)] rounded-t-3xl p-6 pointer-events-auto animate-slide-up relative max-h-[85vh] overflow-y-auto">
                        <div className="w-12 h-1.5 bg-gray-600 rounded-full mx-auto mb-6 opacity-30"></div>
                        <div className="space-y-5">
                            <h2 className="text-lg font-bold text-[var(--text-main)] mb-4 flex items-center gap-2"><Edit2 size={18}/> ç·¨é›†</h2>
                            <Input label="ã‚·ãƒªãƒ¼ã‚º" name="seriesName" value={data.seriesName} onChange={handleChange}/>
                            <div className="flex gap-4"><div className="w-1/3"><Input label="å·»æ•°" type="number" name="volume" value={data.volume} onChange={handleChange}/></div><div className="w-2/3"><Input label="è‘—è€…" name="author" value={data.author} onChange={handleChange}/></div></div>
                            <Input label="ã‚¿ã‚¤ãƒˆãƒ«" name="fullTitle" value={data.fullTitle} onChange={handleChange}/>
                            <div>
                                <label className="text-xs font-bold text-[var(--text-sub)] ml-1 mb-1 block">ç”»åƒURL</label>
                                <div className="neu-pressed rounded-xl p-1 flex items-center"><input type="text" name="cover" value={data.cover||''} onChange={handleChange} className="bg-transparent w-full p-2 text-sm outline-none text-[var(--text-main)]" placeholder="https://..."/>{data.cover && <img src={data.cover} className="h-8 w-6 object-cover rounded ml-2"/>}</div>
                                <a href={`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(data.fullTitle+' '+(data.volume||'')+' è¡¨ç´™')}`} target="_blank" className="text-[10px] text-[var(--accent)] mt-1 ml-1 flex items-center gap-1"><Search size={10}/> ç”»åƒæ¤œç´¢</a>
                            </div>
                            <button onClick={()=>{onSave(data);onClose()}} className="w-full neu-btn py-3 mt-4 text-[var(--accent)] font-bold text-sm">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            );
        }

        const Input = ({ label, name, value, onChange, type="text" }) => (
            <div><label className="text-xs font-bold text-[var(--text-sub)] ml-1 mb-1 block">{label}</label><div className="neu-pressed rounded-xl p-1"><input type={type} name={name} value={value||''} onChange={onChange} className="bg-transparent w-full p-2 text-sm outline-none text-[var(--text-main)]"/></div></div>
        );

        function SettingsView({ settings, setSettings }) {
            const [test, setTest] = useState(null);
            const handleChange = e => setSettings({...settings, [e.target.name]: e.target.value});
            const runTest = async () => {
                setTest('testing');
                try {
                    const p = settings.proxyUrl;
                    const u = p.includes('corsproxy.io') ? p + encodeURIComponent('https://httpbin.org/get') : p + 'https://httpbin.org/get';
                    const r = await fetch(u);
                    if(r.ok) setTest('ok'); else if(r.status===403) setTest('403'); else throw new Error();
                } catch(e) { setTest('err'); }
            };
            return (
                <div className="space-y-6 pt-4 animate-slide-up">
                    <div className="neu-flat p-5 space-y-4">
                        <h3 className="font-bold text-[var(--accent)] flex items-center gap-2"><SettingsIcon size={18}/> Notionè¨­å®š</h3>
                        <Input label="API Token" name="notionToken" value={settings.notionToken} onChange={handleChange} type="password"/>
                        <Input label="Database ID" name="databaseId" value={settings.databaseId} onChange={handleChange}/>
                    </div>
                    <div className="neu-flat p-5 space-y-4">
                        <h3 className="font-bold text-[var(--accent)] flex items-center gap-2">ğŸŒ é€šä¿¡è¨­å®š</h3>
                        <Input label="Proxy URL" name="proxyUrl" value={settings.proxyUrl} onChange={handleChange}/>
                        <div className="grid grid-cols-2 gap-3 pt-2">
                            <button onClick={()=>setSettings({...settings, proxyUrl: 'https://corsproxy.io/?'})} className={`neu-btn py-2 text-xs font-bold ${settings.proxyUrl.includes('corsproxy.io')?'text-[var(--accent)]':'text-[var(--text-sub)]'}`}>Proxy A</button>
                            <button onClick={()=>setSettings({...settings, proxyUrl: 'https://cors-anywhere.herokuapp.com/'})} className={`neu-btn py-2 text-xs font-bold ${settings.proxyUrl.includes('cors-anywhere')?'text-[var(--accent)]':'text-[var(--text-sub)]'}`}>Proxy B</button>
                        </div>
                        <div className="pt-2">
                            <div className="flex justify-between items-center bg-[#202330] p-3 rounded-lg border border-white/5">
                                <span className="text-xs font-bold">æ¥ç¶šãƒ†ã‚¹ãƒˆ</span>
                                <button onClick={runTest} className="neu-btn px-3 py-1 text-xs">{test==='testing'?'...':'å®Ÿè¡Œ'}</button>
                            </div>
                            {test==='ok'&&<p className="text-xs text-green-400 mt-2 text-center">âœ… æ¥ç¶šOK</p>}
                            {test==='403'&&<p className="text-xs text-red-400 mt-2 text-center">âŒ <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank" className="underline">è¨±å¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</a></p>}
                            {test==='err'&&<p className="text-xs text-red-400 mt-2 text-center">âŒ ã‚¨ãƒ©ãƒ¼ (Proxyå¤‰æ›´)</p>}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
