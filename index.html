<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Manga Scanner v3</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTML5-QRCode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        body { background-color: #f3f4f6; }
        #reader video { object-fit: cover; border-radius: 0.5rem; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: ã‚¿ã‚¤ãƒˆãƒ«è§£æ ---
        // "ONE PIECE 100" ã‚„ "é€²æ’ƒã®å·¨äºº(34)" ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã¨å·»æ•°ã‚’åˆ†é›¢ã™ã‚‹
        const parseBookTitle = (rawTitle) => {
            // ãƒ‘ã‚¿ãƒ¼ãƒ³: æœ«å°¾ãŒæ•°å­—ã€ã‚ã‚‹ã„ã¯ã‚«ãƒƒã‚³ã«å…¥ã£ãŸæ•°å­—
            // ä¾‹: "Title 10", "Title (10)", "Titleï¼ˆ10ï¼‰"
            const regex = /^(.+?)\s*[\(ï¼ˆ]?\s*(\d+)[\)ï¼‰]?$/;
            const match = rawTitle.match(regex);

            if (match) {
                return {
                    full: rawTitle,
                    series: match[1].trim(),
                    volume: parseInt(match[2], 10)
                };
            } else {
                return {
                    full: rawTitle,
                    series: rawTitle,
                    volume: null // å·»æ•°ãŒåˆ¤å®šã§ããªã„å ´åˆã¯null
                };
            }
        };

        // --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: ã‚¢ãƒ—ãƒªæœ¬ä½“ ---
        function App() {
            const [view, setView] = useState('scan');
            const [scannedBooks, setScannedBooks] = useState([]);
            const [settings, setSettings] = useState({
                notionToken: '',
                databaseId: '',
                proxyUrl: 'https://cors-anywhere.herokuapp.com/'
            });

            useEffect(() => {
                const savedSettings = localStorage.getItem('manga_scanner_settings');
                if (savedSettings) setSettings(JSON.parse(savedSettings));
                
                const savedHistory = localStorage.getItem('manga_scanner_history');
                if (savedHistory) setScannedBooks(JSON.parse(savedHistory));
            }, []);

            useEffect(() => {
                localStorage.setItem('manga_scanner_history', JSON.stringify(scannedBooks));
            }, [scannedBooks]);

            const addBook = (book) => {
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                if (scannedBooks.some(b => b.isbn === book.isbn)) {
                    alert(`ã€Œ${book.fullTitle}ã€ã¯æ—¢ã«ãƒªã‚¹ãƒˆã«ã‚ã‚Šã¾ã™ã€‚`);
                    return;
                }
                setScannedBooks([book, ...scannedBooks]);
                if (navigator.vibrate) navigator.vibrate(200);
                setView('history');
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-white shadow-lg flex flex-col">
                    <header className="bg-gray-800 text-white p-4 flex justify-between items-center sticky top-0 z-50">
                        <h1 className="font-bold text-lg">ğŸ“š Scanner v3</h1>
                        <div className="space-x-2">
                            <button onClick={() => setView('scan')} className={`px-3 py-1 rounded ${view === 'scan' ? 'bg-blue-600' : 'bg-gray-700'}`}>Scan</button>
                            <button onClick={() => setView('history')} className={`px-3 py-1 rounded ${view === 'history' ? 'bg-blue-600' : 'bg-gray-700'}`}>List ({scannedBooks.length})</button>
                            <button onClick={() => setView('settings')} className={`px-3 py-1 rounded ${view === 'settings' ? 'bg-blue-600' : 'bg-gray-700'}`}>âš™ï¸</button>
                        </div>
                    </header>

                    <main className="flex-grow p-4">
                        {view === 'scan' && <Scanner onDetected={addBook} />}
                        {view === 'history' && <BookList books={scannedBooks} settings={settings} setBooks={setScannedBooks} />}
                        {view === 'settings' && <Settings settings={settings} setSettings={setSettings} />}
                    </main>
                </div>
            );
        }

        // --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: Scanner ---
        function Scanner({ onDetected }) {
            const [scanning, setScanning] = useState(false);
            const [manualIsbn, setManualIsbn] = useState('');
            const [loading, setLoading] = useState(false);
            const html5QrcodeScannerRef = useRef(null);

            useEffect(() => {
                if (!scanning) return;
                const html5QrcodeScanner = new Html5Qrcode("reader");
                html5QrcodeScannerRef.current = html5QrcodeScanner;

                const config = { 
                    fps: 10, 
                    qrbox: { width: 250, height: 150 },
                    aspect: 1.0,
                    formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13 ]
                };
                
                html5QrcodeScanner.start(
                    { facingMode: "environment" }, 
                    config,
                    (decodedText) => {
                        if (decodedText.startsWith('978')) {
                            stopScanner();
                            fetchBookData(decodedText);
                        }
                    },
                    () => {}
                ).catch(err => {
                    console.error("Camera start failed", err);
                    setScanning(false);
                    alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                });

                return () => stopScanner();
            }, [scanning]);

            const stopScanner = () => {
                if (html5QrcodeScannerRef.current?.isScanning) {
                    html5QrcodeScannerRef.current.stop().then(() => {
                        html5QrcodeScannerRef.current.clear();
                        setScanning(false);
                    }).catch(console.error);
                } else {
                    setScanning(false);
                }
            };

            const fetchBookData = async (isbn) => {
                setLoading(true);
                try {
                    const cleanIsbn = isbn.replace(/[^0-9]/g, '');
                    if (cleanIsbn.length !== 13) throw new Error("ISBNã¯13æ¡å¿…è¦ã§ã™");

                    const res = await fetch(`https://api.openbd.jp/v1/get?isbn=${cleanIsbn}`);
                    const data = await res.json();
                    
                    if (data && data[0]) {
                        const summary = data[0].summary;
                        // ã“ã“ã§ã‚¿ã‚¤ãƒˆãƒ«è§£æã‚’å®Ÿè¡Œ
                        const parsed = parseBookTitle(summary.title);

                        const book = {
                            fullTitle: parsed.full,
                            seriesName: parsed.series,
                            volume: parsed.volume,
                            author: summary.author,
                            publisher: summary.publisher,
                            isbn: summary.isbn,
                            cover: summary.cover || '',
                            raw: data[0]
                        };
                        onDetected(book);
                        setManualIsbn('');
                    } else {
                        alert(`ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ (ISBN: ${cleanIsbn})`);
                    }
                } catch (e) {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${e.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const handleManualSubmit = (e) => {
                e.preventDefault();
                if (manualIsbn) fetchBookData(manualIsbn);
            };

            return (
                <div className="flex flex-col items-center space-y-6">
                    <div className="w-full">
                        <div id="reader" className={`w-full bg-black rounded-lg overflow-hidden border-2 border-gray-300 relative ${scanning ? 'h-64' : 'h-12'}`}>
                            {!scanning && (
                                <div className="absolute inset-0 flex items-center justify-center text-white bg-gray-800 text-sm">ã‚«ãƒ¡ãƒ©åœæ­¢ä¸­</div>
                            )}
                        </div>
                        
                        {!scanning ? (
                            <button onClick={() => setScanning(true)} className="mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg w-full flex justify-center items-center">
                                <span className="mr-2">ğŸ“·</span> ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
                            </button>
                        ) : (
                            <button onClick={stopScanner} className="mt-2 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full shadow w-full">åœæ­¢</button>
                        )}
                    </div>

                    <div className="w-full border-t pt-6">
                        <h3 className="text-center font-bold text-gray-700 mb-3">ã¾ãŸã¯ ISBNå…¥åŠ›</h3>
                        <form onSubmit={handleManualSubmit} className="flex gap-2">
                            <input type="tel" value={manualIsbn} onChange={(e) => setManualIsbn(e.target.value)} placeholder="9784..." className="flex-grow p-3 border rounded" maxLength="13" />
                            <button type="submit" disabled={loading} className="bg-green-600 text-white font-bold px-4 rounded shadow">{loading ? '...' : 'æ¤œç´¢'}</button>
                        </form>
                    </div>

                    {loading && <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div className="bg-white p-4 rounded">æƒ…å ±ã‚’å–å¾—ä¸­...</div></div>}
                </div>
            );
        }

        // --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: BookList ---
        function BookList({ books, settings, setBooks }) {
            const [status, setStatus] = useState({});

            const sendToNotion = async (book) => {
                if (!settings.notionToken || !settings.databaseId) {
                    alert("è¨­å®šç”»é¢ã§APIãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
                    return;
                }

                setStatus(prev => ({ ...prev, [book.isbn]: 'loading' }));

                // Notioné€ä¿¡ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ï¼ˆã“ã“ã‚’ä¿®æ­£ï¼‰
                const payload = {
                    parent: { database_id: settings.databaseId },
                    cover: book.cover ? { type: "external", external: { url: book.cover } } : null,
                    properties: {
                        "åå‰": { title: [{ text: { content: book.fullTitle } }] },
                        // è¿½åŠ : ä½œå“åã¨å·»æ•°
                        "ä½œå“å": { rich_text: [{ text: { content: book.seriesName } }] },
                        "å·»æ•°": book.volume ? { number: book.volume } : null,
                        "è‘—ä½œè€…": { rich_text: [{ text: { content: book.author } }] },
                        "å‡ºç‰ˆç¤¾": { rich_text: [{ text: { content: book.publisher } }] },
                        "ISBN": { rich_text: [{ text: { content: book.isbn } }] }
                    }
                };

                try {
                    const proxy = settings.proxyUrl ? settings.proxyUrl : '';
                    const url = `${proxy}https://api.notion.com/v1/pages`;

                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${settings.notionToken}`,
                            "Content-Type": "application/json",
                            "Notion-Version": "2022-06-28"
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        setStatus(prev => ({ ...prev, [book.isbn]: 'success' }));
                    } else {
                        throw new Error(await response.text());
                    }
                } catch (error) {
                    console.error(error);
                    setStatus(prev => ({ ...prev, [book.isbn]: 'error' }));
                    alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼ã€‚ãƒ—ãƒ­ã‚­ã‚·è¨±å¯æœŸé™åˆ‡ã‚Œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
                }
            };

            const copyAll = () => {
                // ã‚³ãƒ”ãƒ¼å½¢å¼ã‚‚ã€Excelç­‰ã«è²¼ã‚Šã‚„ã™ã„ã‚ˆã†ã«ã‚¿ãƒ–åŒºåˆ‡ã‚Šã§åˆ†å‰²
                const text = books.map(b => `${b.fullTitle}\t${b.seriesName}\t${b.volume || ''}\t${b.author}\t${b.publisher}\t${b.isbn}`).join('\n');
                navigator.clipboard.writeText(text);
                alert("å…¨ä»¶ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆã‚¿ã‚¤ãƒˆãƒ« / ä½œå“å / å·»æ•° / è‘—è€…...ï¼‰");
            };

            const removeBook = (isbn) => {
                if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) setBooks(books.filter(b => b.isbn !== isbn));
            };

            if (books.length === 0) return <div className="text-center text-gray-500 py-10">ãƒªã‚¹ãƒˆã¯ç©ºã§ã™</div>;

            return (
                <div className="space-y-4">
                    <div className="flex justify-end mb-2">
                        <button onClick={copyAll} className="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-gray-700">ğŸ“‹ å…¨ä»¶ã‚³ãƒ”ãƒ¼</button>
                    </div>
                    {books.map((book, idx) => (
                        <div key={idx} className="bg-white border rounded-lg p-3 flex shadow-sm items-start">
                            {book.cover ? <img src={book.cover} className="w-16 h-24 object-cover rounded mr-3 bg-gray-200" /> : <div className="w-16 h-24 bg-gray-200 rounded mr-3 flex items-center justify-center text-xs">No Img</div>}
                            <div className="flex-grow">
                                <h3 className="font-bold text-sm">{book.fullTitle}</h3>
                                {/* åˆ†å‰²çµæœã®è¡¨ç¤º */}
                                <div className="flex items-center text-xs text-blue-600 mb-1 space-x-2">
                                    <span className="bg-blue-50 px-1 rounded">ä½œå“: {book.seriesName}</span>
                                    {book.volume && <span className="bg-blue-50 px-1 rounded">å·»: {book.volume}</span>}
                                </div>
                                <p className="text-xs text-gray-600 mb-2">{book.author} / {book.publisher}</p>
                                
                                <div className="flex space-x-2">
                                    <button onClick={() => sendToNotion(book)} disabled={status[book.isbn] === 'success'} className={`text-xs px-3 py-1 rounded text-white ${status[book.isbn] === 'success' ? 'bg-green-500' : status[book.isbn] === 'error' ? 'bg-red-500' : 'bg-blue-600'}`}>
                                        {status[book.isbn] === 'success' ? 'é€ä¿¡æ¸ˆ' : 'Notionã¸é€ä¿¡'}
                                    </button>
                                    <button onClick={() => removeBook(book.isbn)} className="text-xs text-red-400 p-1">å‰Šé™¤</button>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        // --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: Settings (å¤‰æ›´ãªã—) ---
        function Settings({ settings, setSettings }) {
            const handleChange = (e) => {
                const { name, value } = e.target;
                setSettings({ ...settings, [name]: value });
                localStorage.setItem('manga_scanner_settings', JSON.stringify({ ...settings, [name]: value }));
            };
            return (
                <div className="space-y-4 pb-10">
                    <h2 className="font-bold text-xl mb-4">è¨­å®š</h2>
                    <div><label className="block text-sm">Notion Integration Token</label><input type="password" name="notionToken" value={settings.notionToken} onChange={handleChange} className="w-full p-2 border rounded" /></div>
                    <div><label className="block text-sm">Database ID</label><input type="text" name="databaseId" value={settings.databaseId} onChange={handleChange} className="w-full p-2 border rounded" /></div>
                    <div><label className="block text-sm">CORS Proxy URL</label><input type="text" name="proxyUrl" value={settings.proxyUrl} onChange={handleChange} className="w-full p-2 border rounded" />
                    <p className="text-xs text-blue-500 mt-2"><a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank" className="underline">Proxyè¨±å¯ã®æ›´æ–°</a></p></div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
