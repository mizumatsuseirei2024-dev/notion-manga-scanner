<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Manga Scanner v4.16</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTML5-QRCode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        body { background-color: #f3f4f6; }
        #reader video { object-fit: cover; border-radius: 0.5rem; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: ã‚¿ã‚¤ãƒˆãƒ«è§£æ ---
        const parseBookTitle = (rawTitle, onixVolume = null) => {
            if (!rawTitle) return { full: "", series: "", volume: null };
            let title = rawTitle.replace(/[ï¼-ï½]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).trim();
            title = title.replace(/\s+/g, ' ');

            let seriesName = title;
            let volume = null;

            if (onixVolume) {
                volume = parseInt(onixVolume, 10);
                const cleanRegex = new RegExp(`[\\s\\(ï¼ˆ\\[]*?(?:ç¬¬|v|vol\\.?)?\\s*${volume}(?:å·»)?[\\)ï¼‰\\]]*?(?:\\(.+?\\)|ï¼ˆ.+?ï¼‰|<.+?>)?$`, 'i');
                seriesName = title.replace(cleanRegex, '').trim();
                seriesName = seriesName.replace(/[\(\[\-]$/, '').trim();
                return { full: rawTitle, series: seriesName, volume: volume };
            }

            const regex = /^(.+?)[\s\.\-\(ï¼ˆ\[]*?(?:ç¬¬|v|vol\.?|volume|part)?\s*(\d+)(?:å·»)?[\s\)ï¼‰\]]*?(?:\(.+?\)|ï¼ˆ.+?ï¼‰|<.+?>)?$/i;
            const match = title.match(regex);

            if (match) {
                seriesName = match[1].trim();
                volume = parseInt(match[2], 10);
                seriesName = seriesName.replace(/[\(\[\-]$/, '').trim();
            }

            return { 
                full: rawTitle, 
                series: seriesName, 
                volume: volume 
            };
        };

        // --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: ã‚¢ãƒ—ãƒªæœ¬ä½“ ---
        function App() {
            const [view, setView] = useState('scan');
            const [scannedBooks, setScannedBooks] = useState([]);
            const [settings, setSettings] = useState({
                notionToken: '',
                databaseId: '',
                proxyUrl: 'https://cors-anywhere.herokuapp.com/'
            });

            useEffect(() => {
                const savedSettings = localStorage.getItem('manga_scanner_settings');
                if (savedSettings) {
                    const parsed = JSON.parse(savedSettings);
                    if (!parsed.proxyUrl) parsed.proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                    setSettings(parsed);
                }
                
                const savedHistory = localStorage.getItem('manga_scanner_history');
                if (savedHistory) setScannedBooks(JSON.parse(savedHistory));
            }, []);

            useEffect(() => {
                localStorage.setItem('manga_scanner_settings', JSON.stringify(settings));
            }, [settings]);

            useEffect(() => {
                localStorage.setItem('manga_scanner_history', JSON.stringify(scannedBooks));
            }, [scannedBooks]);

            const addBook = (book) => {
                if (scannedBooks.some(b => b.isbn === book.isbn)) {
                    alert(`ã€Œ${book.fullTitle}ã€ã¯æ—¢ã«ãƒªã‚¹ãƒˆã«ã‚ã‚Šã¾ã™ã€‚`);
                    return;
                }
                setScannedBooks([book, ...scannedBooks]);
                if (navigator.vibrate) navigator.vibrate(200);
                setView('history');
            };

            const updateBook = (updatedBook) => {
                setScannedBooks(scannedBooks.map(b => b.isbn === updatedBook.isbn ? updatedBook : b));
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-white shadow-lg flex flex-col">
                    <header className="bg-gray-800 text-white p-4 flex justify-between items-center sticky top-0 z-50">
                        <h1 className="font-bold text-lg">ğŸ“š Scanner v4.16</h1>
                        <div className="space-x-2">
                            <button onClick={() => setView('scan')} className={`px-3 py-1 rounded ${view === 'scan' ? 'bg-blue-600' : 'bg-gray-700'}`}>Scan</button>
                            <button onClick={() => setView('history')} className={`px-3 py-1 rounded ${view === 'history' ? 'bg-blue-600' : 'bg-gray-700'}`}>List ({scannedBooks.length})</button>
                            <button onClick={() => setView('settings')} className={`px-3 py-1 rounded ${view === 'settings' ? 'bg-blue-600' : 'bg-gray-700'}`}>âš™ï¸</button>
                        </div>
                    </header>

                    <main className="flex-grow p-4">
                        {view === 'scan' && <Scanner onDetected={addBook} />}
                        {view === 'history' && <BookList books={scannedBooks} settings={settings} setBooks={setScannedBooks} onUpdate={updateBook} />}
                        {view === 'settings' && <Settings settings={settings} setSettings={setSettings} />}
                    </main>
                </div>
            );
        }

        // --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: Scanner ---
        function Scanner({ onDetected }) {
            const [scanning, setScanning] = useState(false);
            const [manualIsbn, setManualIsbn] = useState('');
            const [loading, setLoading] = useState(false);
            const html5QrcodeScannerRef = useRef(null);

            useEffect(() => {
                if (!scanning) return;
                const html5QrcodeScanner = new Html5Qrcode("reader");
                html5QrcodeScannerRef.current = html5QrcodeScanner;

                const config = { 
                    fps: 10, 
                    qrbox: { width: 250, height: 150 },
                    aspect: 1.0,
                    formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13 ]
                };
                
                html5QrcodeScanner.start(
                    { facingMode: "environment" }, 
                    config,
                    (decodedText) => {
                        if (decodedText.startsWith('978')) {
                            stopScanner();
                            fetchBookData(decodedText);
                        }
                    },
                    () => {}
                ).catch(err => {
                    console.error(err);
                    setScanning(false);
                    alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                });

                return () => stopScanner();
            }, [scanning]);

            const stopScanner = () => {
                if (html5QrcodeScannerRef.current?.isScanning) {
                    html5QrcodeScannerRef.current.stop().then(() => {
                        html5QrcodeScannerRef.current.clear();
                        setScanning(false);
                    }).catch(console.error);
                } else {
                    setScanning(false);
                }
            };

            const fetchBookData = async (isbn) => {
                setLoading(true);
                try {
                    const cleanIsbn = isbn.replace(/[^0-9]/g, '');
                    if (cleanIsbn.length !== 13) throw new Error("ISBNã¯13æ¡å¿…è¦ã§ã™");

                    const res = await fetch(`https://api.openbd.jp/v1/get?isbn=${cleanIsbn}`);
                    const data = await res.json();
                    
                    if (data && data[0]) {
                        const summary = data[0].summary;
                        const onix = data[0].onix;

                        let titleText = summary.title;
                        let authorText = summary.author;
                        let publisherText = summary.publisher;
                        let coverUrl = summary.cover;

                        let onixVolume = null;
                        try {
                             if (onix?.DescriptiveDetail?.TitleDetail?.TitleElement) {
                                 const elements = Array.isArray(onix.DescriptiveDetail.TitleDetail.TitleElement) 
                                     ? onix.DescriptiveDetail.TitleDetail.TitleElement 
                                     : [onix.DescriptiveDetail.TitleDetail.TitleElement];
                                 const partNumEl = elements.find(el => el.PartNumber);
                                 if (partNumEl) onixVolume = partNumEl.PartNumber;
                             }
                        } catch (err) { console.log("ONIX parse error", err); }

                        try {
                            const gRes = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${cleanIsbn}`);
                            const gData = await gRes.json();
                            if (gData.items && gData.items.length > 0) {
                                const gInfo = gData.items[0].volumeInfo;
                                if (!coverUrl && gInfo.imageLinks?.thumbnail) {
                                    coverUrl = gInfo.imageLinks.thumbnail.replace(/^http:\/\//, 'https://');
                                }
                                if (gInfo.authors && gInfo.authors.length > 0) {
                                    authorText = gInfo.authors.join(', ');
                                }
                                if (gInfo.title && !onixVolume) {
                                    const gParsed = parseBookTitle(gInfo.title);
                                    if (gParsed.volume !== null) titleText = gInfo.title;
                                }
                                if (!publisherText && gInfo.publisher) publisherText = gInfo.publisher;
                            }
                        } catch (gErr) { console.warn("Google Books fallback failed", gErr); }

                        const parsed = parseBookTitle(titleText, onixVolume);
                        const book = {
                            fullTitle: parsed.full,
                            seriesName: parsed.series,
                            volume: parsed.volume,
                            author: authorText,
                            publisher: publisherText,
                            isbn: summary.isbn,
                            cover: coverUrl || '',
                        };
                        onDetected(book);
                        setManualIsbn('');
                    } else {
                        alert(`ãƒ‡ãƒ¼ã‚¿ãªã— (ISBN: ${cleanIsbn})`);
                    }
                } catch (e) {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${e.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const handleManualSubmit = (e) => {
                e.preventDefault();
                if (manualIsbn) fetchBookData(manualIsbn);
            };

            return (
                <div className="flex flex-col items-center space-y-6">
                    <div className="w-full">
                        <div id="reader" className={`w-full bg-black rounded-lg overflow-hidden border-2 border-gray-300 relative ${scanning ? 'h-64' : 'h-12'}`}>
                            {!scanning && <div className="absolute inset-0 flex items-center justify-center text-white bg-gray-800 text-sm">ã‚«ãƒ¡ãƒ©åœæ­¢ä¸­</div>}
                        </div>
                        {!scanning ? (
                            <button onClick={() => setScanning(true)} className="mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg w-full flex justify-center items-center">
                                <span className="mr-2">ğŸ“·</span> ã‚«ãƒ¡ãƒ©èµ·å‹•
                            </button>
                        ) : (
                            <button onClick={stopScanner} className="mt-2 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full shadow w-full">åœæ­¢</button>
                        )}
                    </div>
                    <div className="w-full border-t pt-6">
                        <h3 className="text-center font-bold text-gray-700 mb-3">ISBNæ‰‹å…¥åŠ›</h3>
                        <form onSubmit={handleManualSubmit} className="flex gap-2">
                            <input type="tel" value={manualIsbn} onChange={(e) => setManualIsbn(e.target.value)} placeholder="9784..." className="flex-grow p-3 border rounded" maxLength="13" />
                            <button type="submit" disabled={loading} className="bg-green-600 text-white font-bold px-4 rounded shadow">{loading ? '...' : 'æ¤œç´¢'}</button>
                        </form>
                    </div>
                    {loading && <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div className="bg-white p-4 rounded">æƒ…å ±ã‚’å–å¾—ä¸­...</div></div>}
                </div>
            );
        }

        // --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ---
        function EditModal({ book, onClose, onSave }) {
            const [formData, setFormData] = useState({ ...book });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: name === 'volume' ? (value ? parseInt(value, 10) : '') : value
                }));
            };

            const handleSave = () => {
                onSave(formData);
                onClose();
            };

            const googleImageSearchUrl = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(formData.fullTitle + ' ' + (formData.volume ? formData.volume + 'å·»' : '') + ' è¡¨ç´™')}`;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                            <h3 className="font-bold text-lg">æƒ…å ±ã‚’ç·¨é›†</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                        </div>
                        <div className="p-4 space-y-3">
                            <div><label className="block text-xs font-bold text-gray-700 mb-1">ä½œå“å</label><input type="text" name="seriesName" value={formData.seriesName || ''} onChange={handleChange} className="w-full p-2 border rounded" /></div>
                            <div className="flex gap-2">
                                <div className="flex-grow"><label className="block text-xs font-bold text-gray-700 mb-1">å·»æ•°</label><input type="number" name="volume" value={formData.volume || ''} onChange={handleChange} className="w-full p-2 border rounded" /></div>
                                <div className="flex-grow-[2]"><label className="block text-xs font-bold text-gray-700 mb-1">è‘—è€…</label><input type="text" name="author" value={formData.author || ''} onChange={handleChange} className="w-full p-2 border rounded" /></div>
                            </div>
                            <div><label className="block text-xs font-bold text-gray-700 mb-1">æ­£å¼ã‚¿ã‚¤ãƒˆãƒ«</label><input type="text" name="fullTitle" value={formData.fullTitle || ''} onChange={handleChange} className="w-full p-2 border rounded" /></div>
                            <div><label className="block text-xs font-bold text-gray-700 mb-1">å‡ºç‰ˆç¤¾</label><input type="text" name="publisher" value={formData.publisher || ''} onChange={handleChange} className="w-full p-2 border rounded" /></div>
                            <div>
                                <label className="block text-xs font-bold text-gray-700 mb-1">ç”»åƒURL (æ›¸å½±)</label>
                                <div className="flex gap-2 mb-2">
                                    <input type="text" name="cover" value={formData.cover || ''} onChange={handleChange} className="flex-grow p-2 border rounded text-xs" />
                                    {formData.cover && <img src={formData.cover} className="h-8 w-6 object-cover border" alt="preview" />}
                                </div>
                                <a href={googleImageSearchUrl} target="_blank" className="text-xs text-blue-600 hover:underline">ğŸ” Googleç”»åƒæ¤œç´¢</a>
                            </div>
                        </div>
                        <div className="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onClick={handleSave} className="px-4 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: BookList ---
        function BookList({ books, settings, setBooks, onUpdate }) {
            const [status, setStatus] = useState({});
            const [isSendingAll, setIsSendingAll] = useState(false);
            const [editingBook, setEditingBook] = useState(null);

            const sendToNotion = async (book, silent = false) => {
                if (!settings.notionToken || !settings.databaseId) {
                    if (!silent) alert("è¨­å®šã§ãƒˆãƒ¼ã‚¯ãƒ³ã¨IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                    return false;
                }

                setStatus(prev => ({ ...prev, [book.isbn]: 'loading' }));

                let secureCoverUrl = null;
                if (book.cover && book.cover.trim()) {
                     secureCoverUrl = book.cover.trim().replace(/^http:\/\//i, 'https://');
                     if (secureCoverUrl.includes('books.google.com') || secureCoverUrl.includes('googleapis.com')) {
                         secureCoverUrl = secureCoverUrl.replace('&edge=curl', '');
                     }
                }
                
                const safeText = (text) => text && String(text).trim().length > 0 ? String(text) : "-";

                const payload = {
                    parent: { database_id: settings.databaseId },
                    cover: secureCoverUrl ? { type: "external", external: { url: secureCoverUrl } } : null,
                    properties: {
                        "åå‰": { title: [{ text: { content: safeText(book.fullTitle) } }] },
                        "ä½œå“å": { rich_text: [{ text: { content: safeText(book.seriesName) } }] },
                        ...(book.volume !== null && book.volume !== "" ? { "å·»æ•°": { number: parseInt(book.volume, 10) } } : {}),
                        "è‘—ä½œè€…": { rich_text: [{ text: { content: safeText(book.author) } }] },
                        "å‡ºç‰ˆç¤¾": { rich_text: [{ text: { content: safeText(book.publisher) } }] },
                        "ISBN": { rich_text: [{ text: { content: safeText(book.isbn) } }] },
                        ...(secureCoverUrl ? {
                            "æ›¸å½±URL": { url: secureCoverUrl },
                            "æ›¸å½±": {
                                "files": [
                                    {
                                        "name": safeText(book.fullTitle),
                                        "type": "external",
                                        "external": { "url": secureCoverUrl }
                                    }
                                ]
                            }
                        } : {})
                    }
                };

                try {
                    let proxy = settings.proxyUrl || '';
                    const targetUrl = "https://api.notion.com/v1/pages";
                    const finalUrl = proxy.includes('corsproxy.io') 
                        ? proxy + encodeURIComponent(targetUrl)
                        : proxy + targetUrl;

                    const response = await fetch(finalUrl, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${settings.notionToken}`,
                            "Content-Type": "application/json",
                            "Notion-Version": "2022-06-28"
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        // v4.16: é€ä¿¡æˆåŠŸæ™‚ã«ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                        setBooks(prevBooks => prevBooks.filter(b => b.isbn !== book.isbn));
                        setStatus(prev => {
                            const newStatus = { ...prev };
                            delete newStatus[book.isbn];
                            return newStatus;
                        });
                        return true;
                    } else {
                        const errorObj = await response.json().catch(() => ({}));
                        const errorMsg = errorObj.message || await response.text();
                        console.error("Notion API Error:", errorObj);
                        throw new Error(`[${response.status}] ${errorMsg}`);
                    }
                } catch (error) {
                    console.error(error);
                    setStatus(prev => ({ ...prev, [book.isbn]: 'error' }));
                    
                    if (!silent) {
                        let msg = "é€ä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
                        if (error.message.includes("400")) {
                            msg = "ã€è¨­å®šã‚¨ãƒ©ãƒ¼ã€‘Notionã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nãƒ»ã€Œæ›¸å½±URLã€ã®ç¨®é¡ã¯ã€ŒURLã€ã«ãªã£ã¦ã„ã¾ã™ã‹ï¼Ÿ\nãƒ»ã€Œå·»æ•°ã€ã®ç¨®é¡ã¯ã€Œæ•°å€¤ã€ã«ãªã£ã¦ã„ã¾ã™ã‹ï¼Ÿ\nãƒ»ã€Œæ›¸å½±ã€ã®ç¨®é¡ã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ¡ãƒ‡ã‚£ã‚¢ã€ã§ã™ã‹ï¼Ÿ";
                        } else if (error.message.includes("Network") || error.message.includes("Failed to fetch")) {
                            msg = "ã€é€šä¿¡ã‚¨ãƒ©ãƒ¼ã€‘Proxyã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nè¨­å®š(âš™ï¸)ã‹ã‚‰ã€ŒProxy Bã€ã«åˆ‡ã‚Šæ›¿ãˆã€è¨±å¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚";
                        } else if (error.message.includes("401") || error.message.includes("403")) {
                            msg = "ã€èªè¨¼ã‚¨ãƒ©ãƒ¼ã€‘APIãƒˆãƒ¼ã‚¯ãƒ³ãŒé–“é•ã£ã¦ã„ã‚‹ã‹ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ã‚³ãƒã‚¯ãƒˆãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
                        }
                        alert(msg + "\n\nè©³ç´°: " + error.message);
                    }
                    return false;
                }
            };

            const sendAll = async () => {
                if (books.length === 0) {
                    alert("ãƒªã‚¹ãƒˆã¯ç©ºã§ã™ã€‚");
                    return;
                }
                if (!confirm(`${books.length}å†Šã®ãƒ‡ãƒ¼ã‚¿ã‚’Notionã«é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`)) return;

                setIsSendingAll(true);
                let successCount = 0;
                let failCount = 0;
                
                // v4.16: é€ä¿¡å¯¾è±¡ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å‡¦ç†ï¼ˆé€ä¿¡æˆåŠŸæ™‚ã«booksã‹ã‚‰å‰Šé™¤ã•ã‚Œã‚‹ãŸã‚ï¼‰
                const targets = [...books];

                for (const book of targets) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    const result = await sendToNotion(book, true);
                    if (result) successCount++;
                    else failCount++;
                }

                setIsSendingAll(false);
                alert(`å®Œäº†\næˆåŠŸ: ${successCount}ä»¶\nå¤±æ•—: ${failCount}ä»¶`);
            };

            const copyAll = () => {
                const text = books.map(b => `${b.fullTitle}\t${b.seriesName}\t${b.volume || ''}\t${b.author}\t${b.publisher}\t${b.isbn}`).join('\n');
                navigator.clipboard.writeText(text);
                alert("ã‚³ãƒ”ãƒ¼å®Œäº†");
            };

            const downloadCSV = () => {
                const header = "åå‰,ä½œå“å,å·»æ•°,è‘—ä½œè€…,å‡ºç‰ˆç¤¾,ISBN\n";
                const rows = books.map(b => 
                    `"${b.fullTitle}","${b.seriesName}",${b.volume || ''},"${b.author}","${b.publisher}","${b.isbn}"`
                ).join('\n');
                const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), header + rows], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `manga_list_${new Date().toISOString().slice(0,10)}.csv`;
                a.click();
            };

            const removeBook = (isbn) => {
                if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) setBooks(books.filter(b => b.isbn !== isbn));
            };

            if (books.length === 0) return <div className="text-center text-gray-500 py-10">ãƒªã‚¹ãƒˆã¯ç©ºã§ã™</div>;

            return (
                <div className="space-y-4">
                    <div className="flex flex-wrap justify-end gap-2 mb-2">
                        <button 
                            onClick={sendAll} 
                            disabled={isSendingAll}
                            className={`text-sm px-3 py-1 rounded text-white font-bold border ${isSendingAll ? 'bg-gray-400' : 'bg-blue-600 hover:bg-blue-700 border-blue-800'}`}
                        >
                            {isSendingAll ? 'é€ä¿¡ä¸­...' : 'ğŸš€ ä¸€æ‹¬é€ä¿¡'}
                        </button>
                        <button onClick={downloadCSV} className="text-sm bg-green-100 hover:bg-green-200 px-3 py-1 rounded text-green-800 border border-green-300">
                            ğŸ“¥ CSVä¿å­˜
                        </button>
                        <button onClick={copyAll} className="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-gray-700 border border-gray-300">
                            ğŸ“‹ ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                    {books.map((book, idx) => (
                        <div key={idx} className="bg-white border rounded-lg p-3 flex shadow-sm items-start relative">
                            {book.cover ? <img src={book.cover} className="w-16 h-24 object-cover rounded mr-3 bg-gray-200" /> : <div className="w-16 h-24 bg-gray-200 rounded mr-3 flex items-center justify-center text-xs">No Img</div>}
                            <div className="flex-grow">
                                <h3 className="font-bold text-sm">{book.fullTitle}</h3>
                                <div className="flex items-center text-xs text-blue-600 mb-1 space-x-2">
                                    <span className="bg-blue-50 px-1 rounded">ä½œå“: {book.seriesName}</span>
                                    {book.volume !== null && book.volume !== "" && <span className="bg-blue-50 px-1 rounded">å·»: {book.volume}</span>}
                                </div>
                                <p className="text-xs text-gray-600 mb-2">{book.author}</p>
                                <div className="flex space-x-2">
                                    <button onClick={() => sendToNotion(book)} disabled={status[book.isbn] === 'success'} className={`text-xs px-3 py-1 rounded text-white ${status[book.isbn] === 'success' ? 'bg-green-500' : status[book.isbn] === 'error' ? 'bg-red-500' : 'bg-blue-600'}`}>
                                        {status[book.isbn] === 'success' ? 'é€ä¿¡æ¸ˆ' : 'Notionã¸é€ä¿¡'}
                                    </button>
                                    <button onClick={() => setEditingBook(book)} className="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded border">ç·¨é›†</button>
                                    <button onClick={() => removeBook(book.isbn)} className="text-xs text-red-400 p-1">å‰Šé™¤</button>
                                </div>
                            </div>
                        </div>
                    ))}
                    {editingBook && <EditModal book={editingBook} onClose={() => setEditingBook(null)} onSave={onUpdate} />}
                </div>
            );
        }

        // --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: Settings ---
        function Settings({ settings, setSettings }) {
            const [testStatus, setTestStatus] = useState(null); // null, 'testing', 'success', 'error'

            const handleChange = (e) => {
                const { name, value } = e.target;
                setSettings({ ...settings, [name]: value });
                localStorage.setItem('manga_scanner_settings', JSON.stringify({ ...settings, [name]: value }));
                setTestStatus(null);
            };
            
            const setProxy = (url) => {
                const newSettings = { ...settings, proxyUrl: url };
                setSettings(newSettings);
                localStorage.setItem('manga_scanner_settings', JSON.stringify(newSettings));
                setTestStatus(null);
            };

            const testConnection = async () => {
                setTestStatus('testing');
                try {
                    const proxy = settings.proxyUrl;
                    const testTarget = "https://httpbin.org/get";
                    // corsproxy.ioãªã©ã¯ã‚¿ãƒ¼ã‚²ãƒƒãƒˆURLã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹
                    const testUrl = proxy.includes('corsproxy.io') 
                        ? proxy + encodeURIComponent(testTarget)
                        : proxy + testTarget;

                    const res = await fetch(testUrl);
                    if (res.ok) {
                        setTestStatus('success');
                    } else if (res.status === 403) {
                        throw new Error('è¨±å¯ãŒå¿…è¦ã§ã™');
                    } else {
                        throw new Error(res.statusText);
                    }
                } catch (e) {
                    console.error(e);
                    setTestStatus('error');
                }
            };

            return (
                <div className="space-y-4 pb-10">
                    <h2 className="font-bold text-xl mb-4">è¨­å®š</h2>
                    <div><label className="block text-sm">Notion Integration Token</label><input type="password" name="notionToken" value={settings.notionToken} onChange={handleChange} className="w-full p-2 border rounded" /></div>
                    <div><label className="block text-sm">Database ID</label><input type="text" name="databaseId" value={settings.databaseId} onChange={handleChange} className="w-full p-2 border rounded" /></div>
                    
                    <div>
                        <label className="block text-sm">CORS Proxy URL</label>
                        <input type="text" name="proxyUrl" value={settings.proxyUrl} onChange={handleChange} className="w-full p-2 border rounded mb-2" />
                        
                        <div className="flex gap-2 text-xs mb-4">
                            <button onClick={() => setProxy('https://corsproxy.io/?')} className={`px-2 py-1 rounded border ${settings.proxyUrl.includes('corsproxy.io') ? 'bg-blue-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>Proxy A (ç™»éŒ²ä¸è¦)</button>
                            <button onClick={() => setProxy('https://cors-anywhere.herokuapp.com/')} className={`px-2 py-1 rounded border ${settings.proxyUrl.includes('cors-anywhere') ? 'bg-blue-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>Proxy B (è¦è¨±å¯)</button>
                        </div>
                        
                        {/* æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒªã‚¢ */}
                        <div className="p-3 bg-gray-50 rounded border border-gray-200">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-sm font-bold text-gray-700">é€šä¿¡çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯</span>
                                <button onClick={testConnection} disabled={testStatus === 'testing'} className="text-xs bg-white border border-blue-300 text-blue-600 px-3 py-1 rounded hover:bg-blue-50">
                                    {testStatus === 'testing' ? 'ç¢ºèªä¸­...' : 'ğŸ“¡ æ¥ç¶šãƒ†ã‚¹ãƒˆ'}
                                </button>
                            </div>
                            
                            {testStatus === 'success' && (
                                <div className="text-xs text-green-700 bg-green-50 p-2 rounded border border-green-200">
                                    âœ… <strong>æ¥ç¶šOKï¼</strong><br/>ã“ã®è¨­å®šã§Notionã¸é€ä¿¡å¯èƒ½ã§ã™ã€‚
                                </div>
                            )}
                            
                            {testStatus === 'error' && (
                                <div className="text-xs text-red-700 bg-red-50 p-2 rounded border border-red-200">
                                    âŒ <strong>æ¥ç¶šå¤±æ•—</strong>
                                    {settings.proxyUrl.includes('cors-anywhere') ? (
                                        <div className="mt-1 ml-1">
                                            <p className="mb-1">ã€ŒProxy Bã€ã¯ä½¿ç”¨å‰ã«è¨±å¯ãŒå¿…è¦ã§ã™ï¼š</p>
                                            <ol className="list-decimal list-inside space-y-1">
                                                <li><a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank" className="underline text-blue-600 font-bold">è¨±å¯ãƒšãƒ¼ã‚¸ã‚’é–‹ã</a></li>
                                                <li>"Request temporary access" ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™</li>
                                                <li>
                                                    <span className="font-bold bg-yellow-100">â€»ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚‚ç”»é¢ãŒå¤‰ã‚ã‚‰ãªã„å ´åˆã§ã‚‚è¨±å¯ã•ã‚Œã¦ã„ã‚‹äº‹ãŒã‚ã‚Šã¾ã™ã€‚</span>
                                                    <br/>ã‚¢ãƒ—ãƒªã«æˆ»ã£ã¦å†åº¦ã€Œæ¥ç¶šãƒ†ã‚¹ãƒˆã€ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚
                                                </li>
                                            </ol>
                                        </div>
                                    ) : (
                                        <p className="mt-1">Proxy AãŒæ··é›‘ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã€ŒProxy Bã€ã«åˆ‡ã‚Šæ›¿ãˆã¦è©¦ã—ã¦ãã ã•ã„ã€‚</p>
                                    )}
                                </div>
                            )}
                            
                            {testStatus === null && <p className="text-xs text-gray-500">ä¸Šã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦æ¥ç¶šç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
