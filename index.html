<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Manga Scanner</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTML5-QRCode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        body { background-color: #f3f4f6; }
        /* Reader container fix */
        #reader video { object-fit: cover; border-radius: 0.5rem; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: ã‚¢ãƒ—ãƒªæœ¬ä½“ ---
        function App() {
            const [view, setView] = useState('scan'); // 'scan', 'history', 'settings'
            const [scannedBooks, setScannedBooks] = useState([]);
            const [settings, setSettings] = useState({
                notionToken: '',
                databaseId: '',
                proxyUrl: 'https://cors-anywhere.herokuapp.com/' // ãƒ‡ãƒ¢ç”¨ãƒ—ãƒ­ã‚­ã‚· (æœ¬ç•ªåˆ©ç”¨æ™‚ã¯è‡ªå‰æ¨å¥¨)
            });

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è¨­å®šã¨å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
            useEffect(() => {
                const savedSettings = localStorage.getItem('manga_scanner_settings');
                if (savedSettings) setSettings(JSON.parse(savedSettings));
                
                const savedHistory = localStorage.getItem('manga_scanner_history');
                if (savedHistory) setScannedBooks(JSON.parse(savedHistory));
            }, []);

            // å±¥æ­´ä¿å­˜
            useEffect(() => {
                localStorage.setItem('manga_scanner_history', JSON.stringify(scannedBooks));
            }, [scannedBooks]);

            const addBook = (book) => {
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                if (scannedBooks.some(b => b.isbn === book.isbn)) {
                    alert('ã“ã®æœ¬ã¯æ—¢ã«ãƒªã‚¹ãƒˆã«ã‚ã‚Šã¾ã™ã€‚');
                    return;
                }
                setScannedBooks([book, ...scannedBooks]);
                setView('history');
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-white shadow-lg flex flex-col">
                    {/* Header */}
                    <header className="bg-gray-800 text-white p-4 flex justify-between items-center sticky top-0 z-50">
                        <h1 className="font-bold text-lg">ğŸ“š Notion Manga Scanner</h1>
                        <div className="space-x-2">
                            <button onClick={() => setView('scan')} className={`px-3 py-1 rounded ${view === 'scan' ? 'bg-blue-600' : 'bg-gray-700'}`}>Scan</button>
                            <button onClick={() => setView('history')} className={`px-3 py-1 rounded ${view === 'history' ? 'bg-blue-600' : 'bg-gray-700'}`}>List</button>
                            <button onClick={() => setView('settings')} className={`px-3 py-1 rounded ${view === 'settings' ? 'bg-blue-600' : 'bg-gray-700'}`}>âš™ï¸</button>
                        </div>
                    </header>

                    {/* Content */}
                    <main className="flex-grow p-4">
                        {view === 'scan' && <Scanner onDetected={addBook} />}
                        {view === 'history' && <BookList books={scannedBooks} settings={settings} setBooks={setScannedBooks} />}
                        {view === 'settings' && <Settings settings={settings} setSettings={setSettings} />}
                    </main>
                </div>
            );
        }

        // --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ & OpenBDé€£æº ---
        function Scanner({ onDetected }) {
            const [scanning, setScanning] = useState(false);
            const scannerRef = useRef(null);

            useEffect(() => {
                if (!scanning) return;

                const html5QrcodeScanner = new Html5Qrcode("reader");
                const config = { fps: 10, qrbox: { width: 250, height: 150 }, aspect: 1.0 };
                
                html5QrcodeScanner.start(
                    { facingMode: "environment" }, 
                    config,
                    (decodedText) => {
                        // æˆåŠŸæ™‚
                        if (decodedText.startsWith('978')) {
                            html5QrcodeScanner.stop().then(() => {
                                setScanning(false);
                                fetchBookData(decodedText);
                            }).catch(err => console.error(err));
                        }
                    },
                    (errorMessage) => {
                        // èª­ã¿å–ã‚Šä¸­ã®ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
                    }
                ).catch(err => {
                    console.error("Camera start failed", err);
                    setScanning(false);
                    alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚HTTPSç’°å¢ƒã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                });

                return () => {
                    if(html5QrcodeScanner.isScanning) {
                        html5QrcodeScanner.stop().catch(e=>console.error(e));
                    }
                };
            }, [scanning]);

            const fetchBookData = async (isbn) => {
                try {
                    const res = await fetch(`https://api.openbd.jp/v1/get?isbn=${isbn}`);
                    const data = await res.json();
                    
                    if (data && data[0]) {
                        const summary = data[0].summary;
                        const book = {
                            title: summary.title,
                            author: summary.author,
                            publisher: summary.publisher,
                            isbn: summary.isbn,
                            cover: summary.cover || '',
                            raw: data[0]
                        };
                        onDetected(book);
                    } else {
                        alert(`ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ (ISBN: ${isbn})`);
                    }
                } catch (e) {
                    console.error(e);
                    alert("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼");
                }
            };

            return (
                <div className="flex flex-col items-center space-y-4">
                    <div id="reader" className="w-full bg-black rounded-lg overflow-hidden h-64 border-2 border-gray-300 relative">
                        {!scanning && (
                            <div className="absolute inset-0 flex items-center justify-center text-white">
                                ã‚«ãƒ¡ãƒ©åœæ­¢ä¸­
                            </div>
                        )}
                    </div>
                    
                    {!scanning ? (
                        <button 
                            onClick={() => setScanning(true)} 
                            className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg w-full"
                        >
                            ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã‚¹ã‚­ãƒ£ãƒ³
                        </button>
                    ) : (
                        <p className="text-sm text-gray-600">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆISBNï¼‰ã‚’æ ã«åˆã‚ã›ã¦ãã ã•ã„...</p>
                    )}

                    <div className="text-xs text-gray-500 mt-4 bg-gray-100 p-2 rounded">
                        <p>â€» ä¸Šæ®µã®ISBNã‚³ãƒ¼ãƒ‰ï¼ˆ978ã‹ã‚‰å§‹ã¾ã‚‹ã‚‚ã®ï¼‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚</p>
                    </div>
                </div>
            );
        }

        // --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: æ›¸ç±ãƒªã‚¹ãƒˆ & Notioné€ä¿¡ ---
        function BookList({ books, settings, setBooks }) {
            const [status, setStatus] = useState({}); // 'loading', 'success', 'error'

            const sendToNotion = async (book) => {
                if (!settings.notionToken || !settings.databaseId) {
                    alert("è¨­å®šç”»é¢ã§Notion APIãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
                    return;
                }

                setStatus(prev => ({ ...prev, [book.isbn]: 'loading' }));

                const payload = {
                    parent: { database_id: settings.databaseId },
                    cover: book.cover ? { type: "external", external: { url: book.cover } } : null,
                    properties: {
                        "åå‰": { title: [{ text: { content: book.title } }] },
                        "è‘—ä½œè€…": { rich_text: [{ text: { content: book.author } }] },
                        "å‡ºç‰ˆç¤¾": { rich_text: [{ text: { content: book.publisher } }] },
                        "ISBN": { rich_text: [{ text: { content: book.isbn } }] }
                    }
                };

                try {
                    // Notion APIã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹(CORS)ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ãŸã‚ã€ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€
                    // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚’çµŒç”±ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
                    // ã“ã“ã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã—ãŸãƒ—ãƒ­ã‚­ã‚·URLã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
                    
                    const proxy = settings.proxyUrl ? settings.proxyUrl : '';
                    const url = `${proxy}https://api.notion.com/v1/pages`;

                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${settings.notionToken}`,
                            "Content-Type": "application/json",
                            "Notion-Version": "2022-06-28"
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        setStatus(prev => ({ ...prev, [book.isbn]: 'success' }));
                        // æˆåŠŸã—ãŸã‚‰ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã™ã‚‹å ´åˆ
                        // setBooks(books.filter(b => b.isbn !== book.isbn));
                    } else {
                        const errText = await response.text();
                        console.error("Notion Error:", errText);
                        throw new Error("Notion API Error: " + response.status);
                    }
                } catch (error) {
                    console.error(error);
                    setStatus(prev => ({ ...prev, [book.isbn]: 'error' }));
                    alert(`é€ä¿¡å¤±æ•—: ${error.message}\n\nâ€» CORSã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ—ãƒ­ã‚­ã‚·è¨­å®šã‚’ç¢ºèªã™ã‚‹ã‹ã€JSONã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚`);
                }
            };

            const copyToClipboard = (book) => {
                const text = `${book.title}\t${book.author}\t${book.publisher}\t${book.isbn}`;
                navigator.clipboard.writeText(text);
                alert("ã‚¿ãƒ–åŒºåˆ‡ã‚Šãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚Notionã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«è²¼ã‚Šä»˜ã‘å¯èƒ½ã§ã™ã€‚");
            };
            
            const removeBook = (isbn) => {
                setBooks(books.filter(b => b.isbn !== isbn));
            };

            if (books.length === 0) {
                return <div className="text-center text-gray-500 py-10">ã‚¹ã‚­ãƒ£ãƒ³ã—ãŸæœ¬ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>;
            }

            return (
                <div className="space-y-4">
                    {books.map((book, idx) => (
                        <div key={idx} className="bg-white border rounded-lg p-3 flex shadow-sm items-start">
                            {book.cover ? (
                                <img src={book.cover} alt="cover" className="w-16 h-24 object-cover rounded mr-3 bg-gray-200" />
                            ) : (
                                <div className="w-16 h-24 bg-gray-200 rounded mr-3 flex items-center justify-center text-xs text-gray-500">No Img</div>
                            )}
                            <div className="flex-grow">
                                <h3 className="font-bold text-sm mb-1">{book.title}</h3>
                                <p className="text-xs text-gray-600 mb-2">{book.author} / {book.publisher}</p>
                                <div className="flex space-x-2">
                                    <button 
                                        onClick={() => sendToNotion(book)}
                                        disabled={status[book.isbn] === 'success'}
                                        className={`text-xs px-2 py-1 rounded text-white flex items-center ${
                                            status[book.isbn] === 'success' ? 'bg-green-500' : 
                                            status[book.isbn] === 'error' ? 'bg-red-500' : 'bg-blue-600'
                                        }`}
                                    >
                                        {status[book.isbn] === 'loading' ? 'é€ä¿¡ä¸­...' : 
                                         status[book.isbn] === 'success' ? 'é€ä¿¡æ¸ˆ' : 
                                         status[book.isbn] === 'error' ? 'å†è©¦è¡Œ' : 'Notionã¸é€ä¿¡'}
                                    </button>
                                    <button 
                                        onClick={() => copyToClipboard(book)}
                                        className="text-xs px-2 py-1 rounded bg-gray-200 text-gray-700"
                                    >
                                        ã‚³ãƒ”ãƒ¼
                                    </button>
                                    <button onClick={() => removeBook(book.isbn)} className="text-xs text-red-400 p-1">å‰Šé™¤</button>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        // --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: è¨­å®š ---
        function Settings({ settings, setSettings }) {
            const handleChange = (e) => {
                const { name, value } = e.target;
                setSettings({ ...settings, [name]: value });
                localStorage.setItem('manga_scanner_settings', JSON.stringify({ ...settings, [name]: value }));
            };

            return (
                <div className="space-y-4">
                    <h2 className="font-bold text-xl mb-4">è¨­å®š</h2>
                    
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Notion Integration Token</label>
                        <input 
                            type="password" 
                            name="notionToken"
                            value={settings.notionToken}
                            onChange={handleChange}
                            placeholder="secret_..."
                            className="mt-1 block w-full p-2 border border-gray-300 rounded shadow-sm focus:ring-blue-500 focus:border-blue-500"
                        />
                        <p className="text-xs text-gray-500 mt-1">ä½œæˆã—ãŸã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼</p>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700">Database ID</label>
                        <input 
                            type="text" 
                            name="databaseId"
                            value={settings.databaseId}
                            onChange={handleChange}
                            placeholder="32æ¡ã®ID"
                            className="mt-1 block w-full p-2 border border-gray-300 rounded shadow-sm focus:ring-blue-500 focus:border-blue-500"
                        />
                        <p className="text-xs text-gray-500 mt-1">Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®URLã«å«ã¾ã‚Œã‚‹32æ¡ã®æ–‡å­—åˆ—</p>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700">CORS Proxy URL (ä»»æ„)</label>
                        <input 
                            type="text" 
                            name="proxyUrl"
                            value={settings.proxyUrl}
                            onChange={handleChange}
                            placeholder="https://cors-anywhere.herokuapp.com/"
                            className="mt-1 block w-full p-2 border border-gray-300 rounded shadow-sm focus:ring-blue-500 focus:border-blue-500"
                        />
                        <p className="text-xs text-red-500 mt-1">
                            é‡è¦: ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥Notion APIã‚’å‘¼ã¶ã«ã¯CORSãƒ—ãƒ­ã‚­ã‚·ãŒå¿…è¦ã§ã™ã€‚
                            ãƒ‡ãƒ¢ç”¨ã¨ã—ã¦ `https://cors-anywhere.herokuapp.com/` ã‚’å…¥ã‚Œã¦ã„ã¾ã™ãŒã€
                            æœ¬ç•ªåˆ©ç”¨ã§ã¯Cloudflare Workersãªã©ã§è‡ªå‰ã®ãƒ—ãƒ­ã‚­ã‚·ã‚’ç”¨æ„ã™ã‚‹ã‹ã€
                            ã€Œã‚³ãƒ”ãƒ¼ã€æ©Ÿèƒ½ã‚’ä½¿ã£ã¦æ‰‹å‹•è²¼ã‚Šä»˜ã‘ã—ã¦ãã ã•ã„ã€‚
                        </p>
                        <p className="text-xs text-blue-500 mt-1">
                            â€» cors-anywhereã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ä¸€åº¦ <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank" className="underline">ãƒ‡ãƒ¢ãƒšãƒ¼ã‚¸</a> ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
                        </p>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
