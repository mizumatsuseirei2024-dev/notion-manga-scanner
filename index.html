<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Notion Manga Scanner v5.0.3</title>
    <script>
        window.onerror = function(msg, url, line, col, error) {
            console.error("Error: " + msg + " (Line: " + line + ")");
        };
    </script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTML5-QRCode -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        :root {
            --bg-color: #292d3e;
            --text-main: #e0e6ed;
            --text-sub: #676e8a;
            --accent: #00d1b2; /* Cyan */
            --shadow-light: #353a50;
            --shadow-dark: #1d202c;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Neumorphism Utilities */
        .neu-flat {
            background: var(--bg-color);
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
            border-radius: 1.5rem;
            border: 1px solid rgba(255,255,255,0.02);
        }
        
        .neu-btn {
            background: linear-gradient(145deg, #2c3042, #252838);
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            border-radius: 9999px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .neu-btn:active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            transform: scale(0.98);
        }

        .neu-btn.active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            color: var(--accent);
        }

        .neu-pressed {
            background: var(--bg-color);
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            border-radius: 1rem;
            border: none;
        }

        .neu-input {
            background: var(--bg-color);
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
            border-radius: 0.75rem;
            color: var(--text-main);
            border: none;
            outline: none;
            transition: box-shadow 0.2s;
        }
        .neu-input:focus {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light), 0 0 0 1px var(--accent);
        }

        /* Animations */
        @keyframes slide-up {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }

        @keyframes pop {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* Custom Scrollbar */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        #reader video {
            border-radius: 1rem;
            opacity: 0.8;
            filter: contrast(1.1) brightness(1.1);
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="min-h-screen flex items-center justify-center bg-[#292d3e]">
            <div class="neu-flat w-16 h-16 flex items-center justify-center animate-pulse">
                <span style="font-size: 24px;">üìö</span>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const Icon = ({ children, size = 24, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                {children}
            </svg>
        );
        const ScanLine = (props) => <Icon {...props}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><line x1="7" x2="17" y1="12" y2="12"/></Icon>;
        const List = (props) => <Icon {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></Icon>;
        const SettingsIcon = (props) => <Icon {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>;
        const X = (props) => <Icon {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>;
        const Search = (props) => <Icon {...props}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></Icon>;
        const Edit2 = (props) => <Icon {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></Icon>;

        // --- Logic: Title Parsing ---
        const parseBookTitle = (rawTitle, onixVolume = null) => {
            if (!rawTitle) return { full: "", series: "", volume: null };
            let title = rawTitle.replace(/[ÔºÅ-ÔΩû]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).trim();
            title = title.replace(/\s+/g, ' ');
            let seriesName = title;
            let volume = null;
            if (onixVolume) {
                volume = parseInt(onixVolume, 10);
                const cleanRegex = new RegExp(`[\\s\\(Ôºà\\[]*?(?:Á¨¨|v|vol\\.?)?\\s*${volume}(?:Â∑ª)?[\\)Ôºâ\\]]*?(?:\\(.+?\\)|Ôºà.+?Ôºâ|<.+?>)?$`, 'i');
                seriesName = title.replace(cleanRegex, '').trim().replace(/[\(\[\-]$/, '').trim();
                return { full: rawTitle, series: seriesName, volume: volume };
            }
            const regex = /^(.+?)[\s\.\-\(Ôºà\[]*?(?:Á¨¨|v|vol\.?|volume|part)?\s*(\d+)(?:Â∑ª)?[\s\)Ôºâ\]]*?(?:\(.+?\)|Ôºà.+?Ôºâ|<.+?>)?$/i;
            const match = title.match(regex);
            if (match) {
                seriesName = match[1].trim();
                volume = parseInt(match[2], 10);
                seriesName = seriesName.replace(/[\(\[\-]$/, '').trim();
            }
            return { full: rawTitle, series: seriesName, volume: volume };
        };

        // --- Components ---

        function App() {
            const [view, setView] = useState('scan');
            
            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('manga_scanner_settings');
                const defaults = {
                    notionToken: '',
                    databaseId: '',
                    proxyUrl: 'https://cors-anywhere.herokuapp.com/'
                };
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (!parsed.proxyUrl) parsed.proxyUrl = defaults.proxyUrl;
                        return parsed;
                    } catch (e) { return defaults; }
                }
                return defaults;
            });

            const [scannedBooks, setScannedBooks] = useState(() => {
                const saved = localStorage.getItem('manga_scanner_history');
                return saved ? JSON.parse(saved) : [];
            });

            useEffect(() => { localStorage.setItem('manga_scanner_settings', JSON.stringify(settings)); }, [settings]);
            useEffect(() => { localStorage.setItem('manga_scanner_history', JSON.stringify(scannedBooks)); }, [scannedBooks]);

            const addBook = (book) => {
                if (scannedBooks.some(b => b.isbn === book.isbn)) {
                    alert('„É™„Çπ„Éà„Å´Â≠òÂú®„Åó„Åæ„Åô');
                    return;
                }
                setScannedBooks([book, ...scannedBooks]);
                if (navigator.vibrate) navigator.vibrate(50);
                setView('history');
            };

            const updateBook = (updatedBook) => {
                setScannedBooks(scannedBooks.map(b => b.isbn === updatedBook.isbn ? updatedBook : b));
            };

            return (
                <div className="relative w-full h-screen overflow-hidden flex flex-col">
                    {/* Header */}
                    <div className="flex items-center justify-between px-6 pt-6 pb-2 z-10">
                        <div className="flex items-center gap-3">
                            <div className="neu-flat w-10 h-10 flex items-center justify-center text-xl">üìö</div>
                            <h1 className="text-xl font-bold tracking-wider text-[var(--text-main)]">SCANNER</h1>
                        </div>
                        <div className="text-[10px] text-[var(--text-sub)] font-mono tracking-widest">V5.0.3</div>
                    </div>

                    {/* Main View Area */}
                    <div className="flex-grow overflow-y-auto hide-scrollbar px-4 pb-32">
                        {view === 'scan' && <ScannerView onDetected={addBook} />}
                        {view === 'history' && <HistoryView books={scannedBooks} settings={settings} setBooks={setScannedBooks} onUpdate={updateBook} />}
                        {view === 'settings' && <SettingsView settings={settings} setSettings={setSettings} />}
                    </div>

                    {/* Radial Menu Navigation */}
                    <RadialMenu currentView={view} setView={setView} badgeCount={scannedBooks.length} />
                </div>
            );
        }

        // --- Radial Menu ---
        function RadialMenu({ currentView, setView, badgeCount }) {
            const [isOpen, setIsOpen] = useState(false);

            const toggle = () => setIsOpen(!isOpen);
            const handleSelect = (v) => {
                setView(v);
                setIsOpen(false);
            };

            const menuItems = [
                { id: 'scan', icon: ScanLine, label: 'SCAN', color: '#00d1b2' },
                { id: 'history', icon: List, label: 'LIST', color: '#ff0080' },
                { id: 'settings', icon: SettingsIcon, label: 'SETTING', color: '#7928ca' },
            ];

            return (
                <div className="fixed bottom-8 right-8 z-50 flex items-center justify-center">
                    <div className={`absolute transition-all duration-300 ${isOpen ? 'scale-100 opacity-100' : 'scale-50 opacity-0 pointer-events-none'}`}>
                        {menuItems.map((item, index) => {
                            const angle = (index * 90) / (menuItems.length - 1) + 180;
                            const radius = 90;
                            const x = Math.cos((angle * Math.PI) / 180) * radius;
                            const y = Math.sin((angle * Math.PI) / 180) * radius;
                            const isActive = currentView === item.id;

                            return (
                                <button
                                    key={item.id}
                                    onClick={() => handleSelect(item.id)}
                                    className={`absolute w-12 h-12 rounded-full flex items-center justify-center neu-btn text-[var(--text-main)] transition-all duration-300 ${isActive ? 'text-[var(--accent)] border-[var(--accent)]' : ''}`}
                                    style={{ 
                                        transform: `translate(${x}px, ${y}px)`,
                                        boxShadow: isActive ? `0 0 15px ${item.color}40, 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light)` : undefined
                                    }}
                                >
                                    <item.icon size={20} />
                                    {item.id === 'history' && badgeCount > 0 && (
                                        <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-[9px] flex items-center justify-center text-white font-bold">{badgeCount}</span>
                                    )}
                                </button>
                            );
                        })}
                    </div>

                    <button 
                        onClick={toggle}
                        className={`w-16 h-16 rounded-full neu-btn z-50 transition-transform duration-300 ${isOpen ? 'rotate-45' : 'rotate-0'}`}
                        style={{ color: isOpen ? '#ff4d4d' : 'var(--accent)' }}
                    >
                        <div className="text-2xl font-light">+</div>
                    </button>
                </div>
            );
        }

        // --- Views ---

        function ScannerView({ onDetected }) {
            const [scanning, setScanning] = useState(false);
            const [manualIsbn, setManualIsbn] = useState('');
            const [loading, setLoading] = useState(false);
            const scannerRef = useRef(null);

            useEffect(() => {
                if (!scanning) return;
                const scanner = new Html5Qrcode("reader");
                scannerRef.current = scanner;
                scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 }, aspect: 1.0, formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13 ] }, 
                    (decoded) => { if (decoded.startsWith('978')) { stopScanner(); fetchBookData(decoded); } }, 
                    () => {}
                ).catch(e => { console.error(e); setScanning(false); alert("„Ç´„É°„É©Ëµ∑Âãï„Ç®„É©„Éº"); });
                return () => stopScanner();
            }, [scanning]);

            const stopScanner = () => {
                if (scannerRef.current?.isScanning) scannerRef.current.stop().then(() => scannerRef.current.clear()).catch(console.error);
                setScanning(false);
            };

            const fetchBookData = async (isbn) => {
                setLoading(true);
                try {
                    const cleanIsbn = isbn.replace(/[^0-9]/g, '');
                    if (cleanIsbn.length !== 13) throw new Error("13Ê°Å„ÅÆISBN„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                    
                    const res = await fetch(`https://api.openbd.jp/v1/get?isbn=${cleanIsbn}`);
                    const data = await res.json();
                    
                    if (data && data[0]) {
                        const s = data[0].summary;
                        const o = data[0].onix;
                        let { title: t, author: a, publisher: p, cover: c } = s;
                        let vol = null;

                        try {
                             const te = o?.DescriptiveDetail?.TitleDetail?.TitleElement;
                             const els = Array.isArray(te) ? te : [te];
                             const pel = els?.find(el => el?.PartNumber);
                             if (pel) vol = pel.PartNumber;
                        } catch (e) {}

                        try {
                            const gr = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${cleanIsbn}`);
                            const gd = await gr.json();
                            const gi = gd.items?.[0]?.volumeInfo;
                            if (gi) {
                                if (!c && gi.imageLinks?.thumbnail) c = gi.imageLinks.thumbnail.replace(/^http:\/\//, 'https://');
                                if (gi.authors?.length) a = gi.authors.join(', ');
                                if (gi.title && !vol) { const gp = parseBookTitle(gi.title); if (gp.volume !== null) t = gi.title; }
                                if (!p && gi.publisher) p = gi.publisher;
                            }
                        } catch (e) {}

                        const parsed = parseBookTitle(t, vol);
                        onDetected({
                            fullTitle: parsed.full,
                            seriesName: parsed.series,
                            volume: parsed.volume,
                            author: a,
                            publisher: p,
                            isbn: s.isbn,
                            cover: c || '',
                        });
                        setManualIsbn('');
                    } else {
                        alert("„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü");
                    }
                } catch (e) {
                    alert(e.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleManualSubmit = (e) => {
                e.preventDefault();
                if (manualIsbn) fetchBookData(manualIsbn);
            };

            return (
                <div className="flex flex-col items-center justify-center h-full space-y-8 animate-fade-in pt-8">
                    <div className="relative w-full max-w-xs aspect-square neu-flat flex flex-col items-center justify-center p-4 overflow-hidden group">
                        <div id="reader" className={`w-full h-full rounded-2xl overflow-hidden bg-black/40 ${scanning ? 'opacity-100' : 'opacity-50'}`}></div>
                        {!scanning && (
                            <div className="absolute inset-0 flex items-center justify-center">
                                <button onClick={() => setScanning(true)} className="neu-btn w-20 h-20 rounded-full text-2xl text-[var(--accent)] hover:scale-105 active:scale-95 transition-transform">
                                    <ScanLine size={32} />
                                </button>
                            </div>
                        )}
                        {scanning && <div className="absolute inset-0 pointer-events-none border-2 border-[var(--accent)]/50 rounded-2xl animate-pulse"></div>}
                    </div>

                    {scanning && <button onClick={stopScanner} className="neu-btn px-6 py-2 text-sm text-red-400 font-bold">STOP</button>}

                    <div className="w-full max-w-xs">
                        <div className="neu-pressed flex items-center p-2 rounded-full">
                            <input type="tel" placeholder="ISBN (978...)" value={manualIsbn} onChange={e => setManualIsbn(e.target.value)} className="bg-transparent border-none outline-none text-[var(--text-main)] px-4 py-2 flex-grow font-mono text-lg placeholder-gray-600" maxLength="13" />
                            <button onClick={(e) => { e.preventDefault(); fetchBookData(manualIsbn); }} disabled={loading || manualIsbn.length < 10} className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${manualIsbn.length >= 10 ? 'bg-[var(--accent)] text-[#292d3e]' : 'text-gray-500'}`}>
                                <Search size={18} />
                            </button>
                        </div>
                    </div>

                    {loading && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
                            <div className="neu-flat p-8 flex flex-col items-center animate-pop">
                                <div className="w-10 h-10 border-4 border-[var(--accent)] border-t-transparent rounded-full animate-spin mb-4"></div>
                                <span className="font-bold tracking-widest text-sm">SEARCHING...</span>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function HistoryView({ books, settings, setBooks, onUpdate }) {
            const [status, setStatus] = useState({});
            const [editingBook, setEditingBook] = useState(null);
            const [progress, setProgress] = useState({ current: 0, total: 0, active: false });

            const send = async (book, signal) => {
                if(!settings.notionToken) { alert("Ë®≠ÂÆö„ÅåÂøÖË¶Å„Åß„Åô„ÄÇSETTINGÁîªÈù¢„ÅßË®≠ÂÆö„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"); return; }
                setStatus(p => ({...p, [book.isbn]: 'loading'}));
                
                let cover = book.cover?.trim() || "";
                if(cover) {
                    cover = cover.replace(/^http:\/\//i, 'https://');
                    if(cover.includes('books.google') || cover.includes('googleapis')) cover = cover.replace('&edge=curl','');
                }
                const safe = t => t && String(t).trim().length > 0 ? String(t) : "-";

                const body = {
                    parent: { database_id: settings.databaseId },
                    cover: cover ? { type: "external", external: { url: cover } } : null,
                    properties: {
                        "ÂêçÂâç": { title: [{ text: { content: safe(book.fullTitle) } }] },
                        "‰ΩúÂìÅÂêç": { rich_text: [{ text: { content: safe(book.seriesName) } }] },
                        ...(book.volume ? { "Â∑ªÊï∞": { number: parseInt(book.volume) } } : {}),
                        "Ëëó‰ΩúËÄÖ": { rich_text: [{ text: { content: safe(book.author) } }] },
                        "Âá∫ÁâàÁ§æ": { rich_text: [{ text: { content: safe(book.publisher) } }] },
                        "ISBN": { rich_text: [{ text: { content: safe(book.isbn) } }] },
                        ...(cover ? {
                            "Êõ∏ÂΩ±URL": { url: cover },
                            "Êõ∏ÂΩ±": { files: [{ name: safe(book.fullTitle), type: "external", external: { url: cover } }] }
                        } : {})
                    }
                };

                try {
                    let proxy = settings.proxyUrl;
                    const target = "https://api.notion.com/v1/pages";
                    const url = proxy.includes('corsproxy.io') ? proxy + encodeURIComponent(target) : proxy + target;
                    
                    const res = await fetch(url, {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${settings.notionToken}`, "Content-Type": "application/json", "Notion-Version": "2022-06-28" },
                        body: JSON.stringify(body),
                        signal: signal
                    });

                    if(res.ok) {
                        setBooks(prev => prev.filter(b => b.isbn !== book.isbn));
                        setStatus(p => { const n = {...p}; delete n[book.isbn]; return n; });
                        return true;
                    } else {
                        const err = await res.text();
                        throw new Error(err);
                    }
                } catch(e) {
                    console.error(e);
                    setStatus(p => ({...p, [book.isbn]: 'error'}));
                    // „Çø„Ç§„É†„Ç¢„Ç¶„Éà„ÇÑ„Ç¢„Éú„Éº„Éà„ÅÆÂ†¥Âêà„ÅØ„Ç¢„É©„Éº„Éà„ÇíÂá∫„Åï„Å™„ÅÑÔºà‰∏ÄÊã¨ÈÄÅ‰ø°„ÅÆ„Åü„ÇÅÔºâ
                    if (e.name !== 'AbortError' && !progress.active) {
                        alert("ÈÄÅ‰ø°„Ç®„É©„Éº: " + e.message + "\n\nÈÄö‰ø°Ë®≠ÂÆö(Proxy)„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                    }
                    return false;
                }
            };

            const sendAll = async () => {
                if(!books.length || !confirm(`${books.length}ÂÜäÈÄÅ‰ø°„Åó„Åæ„Åô„ÅãÔºü`)) return;
                
                const targets = [...books];
                setProgress({ current: 0, total: targets.length, active: true });
                
                let success = 0, fail = 0;

                for (let i = 0; i < targets.length; i++) {
                    const book = targets[i];
                    setProgress(prev => ({ ...prev, current: i + 1 }));
                    
                    // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàË®≠ÂÆö (20Áßí)
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 20000);
                    
                    try {
                        // ÂæÖÊ©ü
                        await new Promise(r => setTimeout(r, 1000));
                        const res = await send(book, controller.signal);
                        res ? success++ : fail++;
                    } catch (e) {
                        fail++;
                    } finally {
                        clearTimeout(timeoutId);
                    }
                }
                
                setProgress({ current: 0, total: 0, active: false });
                alert(`ÂÆå‰∫Ü: ÊàêÂäü${success} / Â§±Êïó${fail}`);
            };

            const copyAll = () => {
                const text = books.map(b => `${b.fullTitle}\t${b.seriesName}\t${b.volume||''}\t${b.author}\t${b.isbn}`).join('\n');
                navigator.clipboard.writeText(text);
                alert("„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü");
            };

            const downloadCSV = () => {
                const header = "ÂêçÂâç,‰ΩúÂìÅÂêç,Â∑ªÊï∞,Ëëó‰ΩúËÄÖ,Âá∫ÁâàÁ§æ,ISBN\n";
                const rows = books.map(b => `"${b.fullTitle}","${b.seriesName}",${b.volume||''},"${b.author}","${b.publisher}","${b.isbn}"`).join('\n');
                const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), header + rows], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `manga_list_${new Date().toISOString().slice(0,10)}.csv`; a.click();
            };

            if (books.length === 0) return <div className="h-full flex flex-col items-center justify-center text-[var(--text-sub)] opacity-50"><div className="text-6xl mb-4">üì≠</div><p>NO BOOKS</p></div>;

            return (
                <div className="space-y-6 pt-4 animate-slide-up">
                    <div className="flex justify-between items-center px-2">
                        <span className="text-sm font-bold text-[var(--text-sub)]">{books.length} BOOKS</span>
                        <button 
                            onClick={sendAll} 
                            disabled={progress.active}
                            className={`neu-btn px-4 py-2 text-xs font-bold text-[var(--accent)] hover:text-white ${progress.active ? 'opacity-70' : ''}`}
                        >
                            {progress.active ? `ÈÄÅ‰ø°‰∏≠ (${progress.current}/${progress.total})` : 'ALL SEND'}
                        </button>
                    </div>

                    <div className="grid gap-4">
                        {books.map((book) => (
                            <div key={book.isbn} className="neu-flat p-4 flex gap-4 relative overflow-hidden group">
                                <div className="w-20 h-28 flex-shrink-0 rounded-lg overflow-hidden shadow-lg bg-[#202330] relative">
                                    {book.cover ? <img src={book.cover} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-xs text-gray-600 font-bold">NO IMG</div>}
                                </div>
                                
                                <div className="flex-grow min-w-0 flex flex-col justify-between">
                                    <div>
                                        <div className="flex justify-between items-start">
                                            <h3 className="font-bold text-sm leading-tight line-clamp-2">{book.fullTitle}</h3>
                                            <button onClick={() => {if(confirm('ÂâäÈô§?')) setBooks(books.filter(b=>b.isbn!==book.isbn))}} className="text-[var(--text-sub)] hover:text-red-400"><X size={16}/></button>
                                        </div>
                                        <div className="flex flex-wrap gap-2 mt-2">
                                            <span className="text-[10px] bg-[#202330] px-2 py-1 rounded text-[var(--accent)] border border-[var(--accent)]/20">{book.seriesName}</span>
                                            {book.volume && <span className="text-[10px] bg-[#202330] px-2 py-1 rounded text-white border border-white/10">{book.volume}</span>}
                                        </div>
                                        <p className="text-xs text-[var(--text-sub)] mt-1 truncate">{book.author}</p>
                                    </div>
                                    
                                    <div className="flex gap-3 mt-2 justify-end">
                                        <button onClick={() => setEditingBook(book)} className="p-2 rounded-full neu-btn text-[var(--text-sub)] hover:text-white">
                                            <Edit2 size={14} />
                                        </button>
                                        <button onClick={() => send(book)} disabled={status[book.isbn]==='loading' || progress.active} className={`px-4 py-1.5 rounded-full neu-btn text-xs font-bold ${status[book.isbn]==='error' ? 'text-red-400' : 'text-[var(--accent)]'}`}>
                                            {status[book.isbn]==='loading' ? '...' : status[book.isbn]==='error' ? 'RETRY' : 'SEND'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    {editingBook && <EditDrawer book={editingBook} onClose={() => setEditingBook(null)} onSave={onUpdate} />}
                </div>
            );
        }

        // --- Drawer (Edit) ---
        function EditDrawer({ book, onClose, onSave }) {
            const [data, setData] = useState({ ...book });
            const handleChange = (e) => setData({ ...data, [e.target.name]: e.target.name==='volume' && e.target.value ? parseInt(e.target.value) : e.target.value });

            return (
                <div className="fixed inset-0 z-50 flex items-end justify-center pointer-events-none">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto" onClick={onClose}></div>
                    <div className="neu-flat w-full max-w-md bg-[var(--bg-color)] rounded-t-3xl p-6 pointer-events-auto animate-slide-up relative max-h-[85vh] overflow-y-auto">
                        <div className="w-12 h-1.5 bg-gray-600 rounded-full mx-auto mb-6 opacity-30"></div>
                        
                        <div className="space-y-5">
                            <h2 className="text-lg font-bold text-[var(--text-main)] mb-4 flex items-center gap-2"><Edit2 size={18}/> Á∑®ÈõÜ</h2>
                            <Input label="„Ç∑„É™„Éº„Ç∫Âêç" name="seriesName" value={data.seriesName} onChange={handleChange} />
                            <div className="flex gap-4">
                                <div className="w-1/3"><Input label="Â∑ªÊï∞" type="number" name="volume" value={data.volume} onChange={handleChange} /></div>
                                <div className="w-2/3"><Input label="ËëóËÄÖ" name="author" value={data.author} onChange={handleChange} /></div>
                            </div>
                            <Input label="Ê≠£Âºè„Çø„Ç§„Éà„É´" name="fullTitle" value={data.fullTitle} onChange={handleChange} />
                            
                            <div>
                                <label className="text-xs font-bold text-[var(--text-sub)] ml-1 mb-1 block">ÁîªÂÉèURL</label>
                                <div className="neu-pressed rounded-xl p-1 flex items-center">
                                    <input type="text" name="cover" value={data.cover||''} onChange={handleChange} className="bg-transparent w-full p-2 text-sm outline-none text-[var(--text-main)]" placeholder="https://..." />
                                    {data.cover && <img src={data.cover} className="h-8 w-6 object-cover rounded ml-2" />}
                                </div>
                                <a href={`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(data.fullTitle + ' ' + (data.volume||'') + ' Ë°®Á¥ô')}`} target="_blank" className="text-[10px] text-[var(--accent)] mt-1 ml-1 flex items-center gap-1"><Search size={10}/> ÁîªÂÉèÊ§úÁ¥¢</a>
                            </div>

                            <button onClick={() => { onSave(data); onClose(); }} className="w-full neu-btn py-3 mt-4 text-[var(--accent)] font-bold text-sm">
                                ‰øùÂ≠ò„Åô„Çã
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        const Input = ({ label, name, value, onChange, type="text" }) => (
            <div>
                <label className="text-xs font-bold text-[var(--text-sub)] ml-1 mb-1 block">{label}</label>
                <div className="neu-pressed rounded-xl p-1">
                    <input type={type} name={name} value={value||''} onChange={onChange} className="bg-transparent w-full p-2 text-sm outline-none text-[var(--text-main)]" />
                </div>
            </div>
        );

        function SettingsView({ settings, setSettings }) {
            const [test, setTest] = useState(null);
            const handleChange = (e) => setSettings({...settings, [e.target.name]: e.target.value});
            
            const runTest = async () => {
                setTest('testing');
                try {
                    const p = settings.proxyUrl;
                    const u = p.includes('corsproxy.io') ? p + encodeURIComponent('https://httpbin.org/get') : p + 'https://httpbin.org/get';
                    const r = await fetch(u);
                    if(r.ok) setTest('ok'); else if(r.status===403) setTest('403'); else throw new Error();
                } catch(e) { setTest('err'); }
            };

            return (
                <div className="space-y-6 pt-4 animate-slide-up">
                    <div className="neu-flat p-5 space-y-4">
                        <h3 className="font-bold text-[var(--accent)] flex items-center gap-2"><SettingsIcon size={18}/> NotionË®≠ÂÆö</h3>
                        <Input label="API Token" name="notionToken" value={settings.notionToken} onChange={handleChange} type="password" />
                        <Input label="Database ID" name="databaseId" value={settings.databaseId} onChange={handleChange} />
                    </div>

                    <div className="neu-flat p-5 space-y-4">
                        <h3 className="font-bold text-[var(--accent)] flex items-center gap-2">üåê ÈÄö‰ø°Ë®≠ÂÆö</h3>
                        <Input label="Proxy URL" name="proxyUrl" value={settings.proxyUrl} onChange={handleChange} />
                        
                        <div className="grid grid-cols-2 gap-3 pt-2">
                            <button onClick={()=>setSettings({...settings, proxyUrl: 'https://corsproxy.io/?'})} className={`neu-btn py-2 text-xs font-bold ${settings.proxyUrl.includes('corsproxy.io') ? 'text-[var(--accent)]' : 'text-[var(--text-sub)]'}`}>Proxy A (ÁôªÈå≤‰∏çË¶Å)</button>
                            <button onClick={()=>setSettings({...settings, proxyUrl: 'https://cors-anywhere.herokuapp.com/'})} className={`neu-btn py-2 text-xs font-bold ${settings.proxyUrl.includes('cors-anywhere') ? 'text-[var(--accent)]' : 'text-[var(--text-sub)]'}`}>Proxy B (Ë¶ÅË®±ÂèØ)</button>
                        </div>

                        <div className="pt-2">
                            <div className="flex justify-between items-center bg-[#202330] p-3 rounded-lg border border-white/5">
                                <span className="text-xs font-bold">Êé•Á∂ö„ÉÜ„Çπ„Éà</span>
                                <button onClick={runTest} className="neu-btn px-3 py-1 text-xs">{test==='testing' ? '...' : 'ÂÆüË°å'}</button>
                            </div>
                            {test==='ok' && <p className="text-xs text-green-400 mt-2 text-center">‚úÖ Êé•Á∂öOK</p>}
                            {test==='403' && <p className="text-xs text-red-400 mt-2 text-center">‚ùå <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank" className="underline">Ë®±ÂèØ„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ</a></p>}
                            {test==='err' && <p className="text-xs text-red-400 mt-2 text-center">‚ùå „Ç®„É©„Éº (Proxy„ÇíÂ§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ)</p>}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
